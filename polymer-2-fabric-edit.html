<!--
  Polymer 2 Fabric Edit
  Copyright: (c) 2016 Thinker Works
  Author: Ralph Porter
  Licence: MIT
-->

<!-- Load the Polymer.Element base class -->
<link rel="import" href="bower_components/polymer/polymer-element.html">
<script src="bower_components/fabric.js/dist/fabric.js"></script>
<script src="fabric-brush/dist/fabric-brush.js"></script>

<dom-module id="polymer-2-fabric-edit">
  <template>

    <style>

    .hide {
        display: none;
        visibility: hiddden;
    }
    .show {
        display: block;
        visibility: visible;
    }
    .active {
        background: orange !important;
        color:green;
        font-weight: bold;
      }
      .radioButton {
        background: yellow;
        color: green;
        font-weight: bold;
      }

      input[type=number] {
        width: 80px;
      }

      input[type=text] {
        width: 60px;
      }

    </style>

    <div>
      <div style="display: inline-block; margin-left: 10px">
        <div id="history">
          <center>
            <button id="undoCanvas" class="btn">Undo</button>
            <button id="redoCanvas" class="btn">Redo</button>
            <button id="clearCanvas" class="btn">Clear</button>
            <button id="restoreCanvas" class="btn">Restore</button>
            <br/>
            <br/>
          </center>
        </div>
        <canvas id="c" width="{{canvasWidth}}" height="{{canvasHeight}}" style="border:1px solid {{canvasBorderColor}}"></canvas>
        <br/>
        <div id="fabricEditMenu">
            <input type="button" class="radioButton" id="textButton" name="textButton" value="TEXT"/>
            <input type="button" class="radioButton" id="shapeButton" name="shapeButton" value="SHAPE"/>
            <input type="button" class="radioButton" id="fileButton" name="fileButton" value="FILE"/>
            <input type="button" class="radioButton" id="drawButton" name="drawButton" value="DRAW"/>
            <input type="button" class="radioButton"  id="controlButton" name="controlButton" value="CONTROL"/>
        </div>
        <br/>
      </div>
      <div id="drawTypes" style="display: inline-block; vertical-align:top; margin-left: 10px">
        <div id="textDraw" hidden="{{hideText}}">
        </div>

        <div id="shapeDraw" hidden="{{hideShape}}">
            <p>Add <strong>simple shapes</strong> to canvas:</p>
            <p>
                <button type="button" class="btn" id="shapeSquare">Square</button>
                <button type="button" class="btn" id="shapeRectangle">Rectangle</button>
                <button type="button" class="btn" id="shapeDiamond">Diamond</button>
                <button type="button" class="btn" id="shapeCircle">Circle</button>
                <button type="button" class="btn" id="shapeEllipse">Ellipse</button>
                <button type="button" class="btn" id="shapeTriangle">Triangle</button>
                <br/>
                <button type="button" class="btn" id="shapeHorizontalLine">Horizontal Line</button>
                <button type="button" class="btn" id="shapeVerticleLine">Vertical Line</button>
                <button type="button" class="btn" id="shapeDiagnalLine">Diagnal Line</button>
                <button type="button" class="btn" id="angledLine">Angled Line</button>
                <br/>
                <button type="button" class="btn" id="shapeStar">Star</button>
                <button type="button" class="btn" id="shapePolygon">Polygon</button>
                <button type="button" class="btn" id="shapePolyline">Polyline</button>
                <button type="button" class="btn" id="shapeHexagon">Hexagon</button>

            <p>Add <strong>path-based shapes</strong> to canvas:</p>

                <button type="button" class="btn" id="shapeArrow">Arrow</button>
                <button type="button" class="btn" id="shapeLineArrow">Line Arrow</button>
                <button type="button" class="btn" id="shapeAnchor">Anchor</button>
            </p>

        </div>

        <div id="fileDraw" hidden="{{hideFile}}">


            <div id="dropObjectDiv" style="border:1px solid black;float: left; width: 320px; height: 64px;margin-right:4px; background-color: #eeeeee">
                  <center>
                      <b>Add Object To Canvas</b><br/><br/><font size="-1">Drag & Drop Here <i>or</i></font>
                      <input type="file" id="objectLoader" value="Browse" style="width:200px;"/>
                  </center>
              </div>
              <br/><br/><br/><br/>

              <div  style="border:1px solid black;float: left; width: 320px; height: 110px;margin-right:4px; background-color: #eeeeee">
                <center>
              <div id="dropBackgroundDiv">
                <center>
                    <b>Load Canvas Background</b><br/><br/><font size="-1">Drag & Drop Here <i>or</i></font>
                    <input type="file" id="backgroundLoader" value="Browse" style="width:200px;"/>
                </center>
              </div>
              <i>Or</i>
              <br/>
              <font size="-1"><b>Choose Canvas Background Color</b>: </font>
              <input type="text" value="{{canvasBackgroundColor::input}}" id="canvasBackgroundColorText">
              <input type="color" value="{{canvasBackgroundColor::input}}" id="canvasBackgroundColor"><br>
            </center>
            </div>
              <br/><br/><br/><br/><br/><br/><br/>
              <center>
              <label><b>Imports and Exports</b></label>
              </center>
              <div id="dropCanvasDiv" style="border:1px solid black;float: left; width: 320px; height: 64px;margin-right:4px; background-color: #eeeeee">
                    <center>
                        <b>Load Canvas From File</b><br/><br/><font size="-1">Drag & Drop Here <i>or</i></font>
                        <input type="file" id="canvasLoader" value="Browse" style="width:200px;"/>
                    </center>
              </div>
              <br/><br/><br/><br/>
              <div id="downloadCanvasDiv" style="border:1px solid black;float: left; width: 320px; height: 74px;margin-right:4px; background-color: #eeeeee">
                <center>
                  <table border=0>
                    <tr><th>&nbsp;</th></th><th>Prefix</th><th>Type</th></tr>
                    <tr>
                      <th>Download File Name</th>
                      <td align="center"><input type="text" value="{{downloadFileNamePrefix::input}}"></td>
                      <td align="center">
                        <select id="downloadFileExtension" value="{{downloadFileExtension::input}}">
                            <option value="json">JSON</Option>
                            <option value="jpeg">JPEG</option>
                            <option value="png">PNG</option>
                            <option value="svg">SVG</Option>
                        </select>
                      </td>
                    </tr>
                    <!-- <tr>
                      <td>&nbsp;</td>
                      <td align="center"><input type="text" value="{{downloadFileNamePrefix::input}}"></td>
                      <td align="center">
                        png <input type="radio" name="downloadFileExtension"  value="{{downloadFileExtension::input}}"  />
                        jpeg <input type="radio" name="downloadFileExtension"  value="{{downloadFileExtension::input}}"  />
                        json <input type="radio" name="downloadFileExtension"  value="{{downloadFileExtension::input}}"  />
                      </td>
                    </tr> -->
                    <tr><td colspan="3" align="center"><input type="button" value="Download Canvas to File" id="downloadCanvas"></td></tr>
                  </table>
                  <!-- <input type="button" value="Download as Image File" id="downloadAsImage">
                  <input type="button" value="Download as JSON File" id="downloadAsJSON"> -->
                </center>
              </div>
          </div>
        <div id="freeDraw" hidden="{{hideDraw}}">
          <button id="drawingTool" class="btn">{{drawingMode::input}} Drawing Mode</button><br>
          <br/>
          <div id="drawingToolOptions">
            <label for="drawingToolSelector">Tool:</label>
            <select id="drawingToolSselector" value="{{drawingTool::input}}">
              <option value="Pencil">Pencil</option>
              <option value="Pen">Pen</Option>
              <option value="Marker">Marker</Option>
              <option value="Crayon">Crayon</option>
              <option value="Sprayer">Sprayer</option>
              <option value="Spray">Spray</option>
              <option value="FineSpray">Fine Spray</option>
              <option value="MediumSpray">Medium Spray</option>
              <option value="DenseSpray">Dense Spray</option>
              <option value="Circle">Circle</option>
              <option value="Pattern">Pattern</option>
              <option value="hline">hline</option>
              <option value="vline">vline</option>
              <option value="Square">Square</option>
              <option value+"Diamond">Diamond</option>
              <option value="Texture">Texture</option>
            </select>
            <br>
            <div id="brushTextureOptions" hidden="{{hideBrushTexture}}">
              <label for="brushTextureSelector">Texture:</label>
              <select id="brushTexture" value="{{brushTexture::input}}">
                <option value="honey_im_subtle">Honey Im Subtle</option>
                <option value="bedg_grunge">Bedg Grunge</option>
                <option value="bkg">Bkg</option>
                <option value="blob">Blob</option>
                <option value="excheresque">Excheresque</option>
                <option value="gretfloral">Floral</option>
                <option value="ladybu">Ladybug</option>
                <option value="nasty_fabric">Nasty Fabric</option>
                <option value="retina_wood">Retina Wood</option>
                <option value="ski">Skin</option>
                <option value="night_sky">Night Sky</option>
                <option value="sun">Sun</option>
                <option value="Custom">Custom</option>
              </select><br>
            </div>
            <div id="loadBrushTextureUpload" style="white-space: nowrap; text-align: center; border:1px solid black; width: 320px; height: 64px;margin-right:4px; background-color: #eeeeee" hidden="{{hideBrushTextureUpload}}">
                        <b>Load Texture From Image File</b><br/><br/>
                        <font size="-1">Drag & Drop Here <i>or</i></font>
                        <input id="brushTextureobjectLoader" type="file">
                  <br/><br/><br/><br/><br/><br/><br/>
            </div>
            <label for="drawingColor">Color:</label>
            <input type="text" value="{{brushColor::input}}" style="width: 60px;" id="brushColorText">
            <input type="color" value="{{brushColor::input}}" id="drawingColor"><br>

            <label for="brushWidth">Line Width:</label>
            <input type="number" value="{{brushWidth::input}}" min="0.1" max="100" step="0.10" id="brushWidth">
            <input type="range" value="{{brushWidth::input}}" min="0.1" max="100" step="0.10" id="brushWidthRange"><br>
            <div id="brushTextureOptions" hidden="{{hideBrushTexture}}">
            </div>

            <div id="brushOpacityDiv"  hidden="{{hideBrushOpacity}}">
              <label for="brushOpacity">Opacity:</label>
              <input type="number" value="{{brushOpacity::input}}" min="0.10" max="1" step="0.10" id="brushOpacity">
              <input type="range" value="{{brushOpacity::input}}" min="0.10" max="1" step="0.10" id="brushOpacityRange"><br>
            </div>

            <div id="brushSprayOptions" hidden="{{hideBrushSpray}}">
              <label for="brushDotWidth">Dot Width:</label>
              <input type="number" value="{{brushDotWidth::input}}" min="0.1" max="5" step="0.10" id="brushDotWidth">
              <input type="range" value="{{brushDotWidth::input}}" min="0.1" max="5" step-"0.10" id="brushDotWidthRange"><br>
              <label for="brushDensity">Density:</label>
              <input type="number" value="{{brushDensity::input}}" min="0.1" max="100" step="0.10" id="brushDensity">
              <input type="range" value="{{brushDensity::input}}" min="0.1" max="100" step="0.10" id="brushDensityRange"><br>
              <label for="brushDotWidthVariance">Variance:</label>
              <input type="number" value="{{brushDotWidthVariance::input}}" min="0.1" max="10" step="0.10" id="brushDotWidthVariance">
              <input type="range" value="{{brushDotWidthVariance::input}}" min="0.1" max="10" step="0.10" id="brushDotWidthVarianceRange"><br>
              <label for="brushDotWidthDensity">Density:</label>
              <input type="number" value="{{brushDotWidthDensity::input}}" min="0.1" max="10" step="0.10" id="brushDotWidthDensity">
              <input type="range" value="{{brushDotWidthVDensity::input}}" min="0.1" max="10" step="0.10" id="brushDotWidthDensityRange"><br>
            </div>

            <label for="brushShadowColor">Shadow Color:</label>
            <input type="text" value="{{brushShadowColor::input}}" style="width: 60px;" id="brushShadowColorText">
            <input type="color" value="{{brushShadowColor::input}}" id="brushShadowColor"><br>

            <label for="brushShadowBlur">Shadow Blur:</label>
            <input type="number" value="{{brushShadowBlur::input}}" min="0" max="50" id="brushShadowBlur">
            <input type="range" value="{{brushShadowBlur::input}}" min="0" max="50" id="brushShadowBlurRange"><br>

            <label for="brushShadowOffsetX">Shadow OffsetX:</label>
            <input type="number" value="{{brushShadowOffsetX::input}}" min="0" max="50" id="brushShadowOffsetX">
            <input type="range" value="{{brushShadowOffsetX::input}}" min="0" max="50" id="brushShadowOffsetXRange"><br>

            <label for="brushShadowOffset">Shadow OffsetY:</label>
            <input type="number" value="{{brushShadowOffsetY::input}}" min="0" max="50" id="brushShadowOffsetY">
            <input type="range" value="{{brushShadowOffsetY::input}}" min="0" max="50" id="brushShadowOffsetYRange"><br>
          </div>
        </div>

        <div id="controlDraw" hidden="{{hideControl}}">
        <div id="controlView">
          <span id="fontStyleEdit">
            <label for="fontStyle" class="hide">Font Style:</label>
            <input type="text" class="hide" value="{{fontStyle})" id="fontStyle">
            <select id="fontStyle" class="hide" value="{{fontStyle::input}}">
              <option value=""></option>
              <option value="normal">Normal</option>
              <option value="italic">Italic</option>
              <option value="oblique">Oblique</option>
            </select>
            <br/ class="hide">
            <button type="button" id="bold">bold</button>
          </span>
          <span id="fontWeightEdit">
            <label for="fontWeight" class="hide">Font Weight:</label>
            <input type="text" class="hide" value="{{fontWeight::input}}" id="fontWeight">
            <select id="fontWeight" class="hide" value="{{fontWeight::input}}">
              <option value="normal">normal</option>
              <option value="bold">bold</option>
            </select>
            <br/ class="hide">
          <button type="button" id="italic">Italic</button>
          </span>
          <span id="textDecorationEdit">
            <label for="textDecoration" class="hide">Text Decoration:</label>
            <input type"text" class="hide" value="{{textDecoration::input}}" id="textDecoration">
            <input type="button" value="underline" id="underline">
            <input type="button" value="line-through" id="linethrough">
            <input type="button" value="overline" id="overline">
            <br/>
          </span>
          <div id="fontFamilyEdit">
            <label for="fontFamily">Font Family:</label>
            <select id="fontFamily" class="fontFamily" value="{{fontFamily::input}}" id"fontFamily">
              <option value="arial">Arial</option>
              <option value="helvetica" selected>Helvetica</option>
              <option value="myriad pro">Myriad Pro</option>
              <option value="delicious">Delicious</option>
              <option value="verdana">Verdana</option>
              <option value="georgia">Georgia</option>
              <option value="courier">Courier</option>
              <option value="comic sans ms">Comic Sans MS</option>
              <option value="impact">Impact</option>
              <option value="monaco">Monaco</option>
              <option value="optima">Optima</option>
              <option value="hoefler text">Hoefler Text</option>
              <option value="plaster">Plaster</option>
              <option value="engagement">Engagement</option>
            </select>
            <br/>
          </div>
          <div id="textAlignEdit">
            <label for="textAlign">Text Align:</label>
            <select id="textAlign" class="textAlign" value="{{textAlign::input}}">
              <option value="left">Left</option>
              <option value="center">Center</option>
              <option value="right">Right</option>
              <option value="justify">Justify</option>
            </select>
            <br/>
          </div>
          <div id="fillEdit">
            <label for="fill">Fill Color:</label>
            <input type="text" value="{{fill::input}}" id="fillText">
            <input type="color" value="{{fill::input}}" id="fill">
            <br/>
          </div>
          <div id="strokeEdit">
            <label for="stroke">Stroke Color:</label>
            <input type="text" value="{{stroke::input}}" id="strokeText">
            <input type="color" value="{{stroke::input}}" id="stroke">
            <br/>
          </div>
          <div id="backgroundColorEdit">
            <label for="backgroundColor">Background Color:</label>
            <input type="text" value="{{backgroundColor::input}}" id="backgroundColorText">
            <input type="color" value="{{backgroundColor::input}}" id="backgroundColor">
            <br/>
          </div>
          <div id="textBackgroundColorEdit">
            <label for="textBackgroundColor">Text Background Color:</label>
            <input type="text" value="{{textBackgroundColor::input}}" id="textBackgroundColorText">
            <input type="color" value="{{textBackgroundColor::input}}" id="textBackgroundColor">
            <br/>
          </div>
          <div id="fontSizeEdit">
            <label for="fontSize">Font Size:</label>
            <input type="number" value="{{fontSize::input}}" min="1" max="150" id="fontSize">
            <input type="range" value="{{fontSize::input}}" min="1" max="150" id="fontSizeRange">
            <br/>
          </div>
          <div id="strokeWidthEdit">
            <label for="strokeWidth">Stroke Width:</label>
            <input type="number" value="{{strokeWidth::input}}"  min="0" max="5" step="0.25" id="strokeWidth">
            <input type="range" value="{{strokeWidth::input}}"  min="0" max="5" step="0.25" id="strokeWidthRange">
            <br/>
          </div>
          <div id="lineHeightEdit">
            <label for="lineHeight">Line Height:</label>
            <input type="number" value="{{lineHeight::input}}" min="0.25" max="5" step="0.25" id="lineHeight">
            <input type="range" value="{{lineHeight::input}}" min="0.25" max="5" step="0.25" id="lineHeightRange">
            <br/>
          </div>
          <div id="charSpacingEdit">
            <label for="lineHeight">Char Spacing:</label>
            <input type="number" value="{{charSpacing::input}}" min="0.25" max="5" step="0.25" id="charSpacingt">
            <input type="range" value="{{charSpacing::input}}" min="0.25" max="5" step="0.25" id="charSpacingRange">
            <br/>
          </div>
          <div id="angleEdit">
            <label for="angle">Angle:</label>
            <input type="number" value="{{angle::input}}" min="-180" max="180" id="angle">
            <input type="range" value="{{angle::input}}" min="-180" max="180" id="angleRange">
            <br/>
          </div>
          <div id="strokeDashArrayEdit">
            <label for="strokeLineStyle">Stroke Dash Array:</label>
            <select id="strokeLineStyle" value="{{strokeLineStyle::input}}">
              <option value="Solid">Solid</option>
              <option value="Dotted">Dotted</Option>
              <option value="Dashed">Dashed</Option>
              <option value="DotDash">Dot Dash</Option>
              <option value="Custom">Custom</option>
            </select>
            <input type="text" value="{{strokeDashArray::input}}" id="strokeDashArray">
            <br/>
          </div>
          <div id="shadowEdit">
            <label for="shadow" class="hide">Shadow:</label>
            <input type="text" class="hide" value="{{shadow::input}}" id="shadow" style="width: 100px;">
            <br/ class="hide">
            <label for="shadowColor">Shadow Color:</label>
            <input type="text" value="{{shadowColor::input}}" id="shadowText">
            <input type="color" value="{{shadowColor::input}}" id="shadow">
            <br/>
            <label for="shadowBlur">Shadow Blur:</label>
            <input type="number" value="{{shadowBlur::input}}" min="-20" max="20" id="shadowBlur">
            <input type="range" value="{{shadowBlur::input}}" min="-20" max="20" id="shadowBlurRange">
            <br/>
            <label for="shadowOffsetX">Shadow OffsetX:</label>
            <input type="number" value="{{shadowOffsetX::input}}" min="-20" max="20" id="shadowOffsetX">
            <input type="range" value="{{shadowOffsetX::input}}" min="-20" max="20" id="shadowOffsetXRange">
            <br/>
            <label for="shadowOffsetY">Shadow OffsetY:</label>
            <input type="number" value="{{shadowOffsetY::input}}" min="-20" max="20" id="shadowOffsetY">
            <input type="range" value="{{shadowOffsetY::input}}" min="-20" max="20" id="shadowOffsetYRange">
            <br/>
          </div>
          <div id="textEdit">
            <label for="text">Text:</label>
            <textarea id="text" rows="5" cols="40">{{text::input}}</textarea>
            <br/>
            <div ed="addTextEdit">
              <center><button type="button" class="addTextButton" id="addText">Add Text To Canvas</button></center>
            </div>
          </div>
          <div id="topEdit">
            <label for="top">Top:</label>
            <input type="number" value="{{top::input}}" min="0" max="150" id="top">
            <input type="range" value="{{top::input}}" min="0" max="150" id="topRange">
            <br/>
          </div>
          <div id="leftEdit">
            <label for="left">Left:</label>
            <input type="number" value="{{left::input}}" min="0" max="150" id="left" onchange="{{Change}}">
            <input type="range" value="{{left::input}}" min="0" max="150" id="leftRange">
            <br/>
          </div>
          <div id="widthEdit">
            <label for="width">Width:</label>
            <input type="number" value="{{width::input}}" min="0" max="150" id="width">
            <input type="range" value="{{width::input}}" min="0" max="150" id="widtnRange">
            <br/>
          </div>
          <div id="heightEdit">
            <label for="height">Height:</label>
            <input type="number" value="{{height::input}}" min="0" max="150" id="height">
            <input type="range" value="{{height::input}}" min="0" max="150" id="heightRange">
            <br/>
          </div>
          <div id="scaleXEdit">
            <label for="scaleX">ScaleX:</label>
            <input type="number" value="{{scaleX::input}}" min="0" max="10" step="0.25" id="scaleX">
            <input type="range" value="{{scaleX::input}}" min="0" max="10" step="0.25" id="scaleXRange">
            <br/>
          </div>
          <div id="scaleYEdit">
            <label for="scaleY">ScaleY:</label>
            <input type="number" value="{{scaleY::input}}" min="0" max="10" step="0.25" id="scaleY">
            <input type="range" value="{{scaleY::input}}" min="0" max="10" step="0.25" id="scaleYRange">
            <br/>
          </div>
          <div id="flipXEdit">
            <label for="flipX">FlipX:</label>
            <!-- <input type="text" value="{{flipX::input}}" id="flipX"> -->
            <input type="button" value="{{flipX::input}}" id="flipX">
          <br/>
          </div>
          <div id="flipYEdit">
            <label for="flipY">FlipY:</label>
            <!-- <input type="text" value="{{flipY::input}}" id="flipY"> -->
            <input type="button" value="{{flipY::input}}" id="flipY">
            <br/>
          </div>
          <div id="origionXEdit">
            <label for="originX">OriginX:</label>
            <!-- <input type="text" value="{{originX::input}}" id="originX"> -->
            <select id="origionX" class="origionX" value="{{origionX::input}}">
              <option value="left">Left</option>
              <option value="center">Center</option>
              <option value="right">Right</option>
            </select>
            <br/>
          </div>
          <div id="origionYEdit">
            <label for="originY">OrigionY:</label>
            <!-- <input type="text" value="{{originY::input}}" id="originY"> -->
            <select id="origionY" class="origionY" value="{{origionY::input}}">
              <option value="top">Top</option>
              <option value="center">Center</option>
              <option value="bottom">Bottom</option>
            </select>
            <br/>
          </div>
          <div id="trnsfomMatrixEdit">
            <label for="trnsformMatrix">Transform Matrix:</label>
            <input type="text" value="{{transformMatrix::input}}" id="transformMatrix">
            <br/>
          </div>
          <div id="strokeLineCapEdit">
            <label for="strokeLineCap">Stroke Line Cap:</label>
            <!-- <input type="text" value="{{strokeLineCap::input}}" id="strokeLineCap"> -->
            <select id="strokeLineCap" class="strokeLineCap" value="{{strokeLineCap::input}}">
              <option value="butt">butt</option>
              <option value="round">round</option>
              <option value="square">square</option>
            </select>
            <br/>
          </div>
          <div id="strokeLineJointEdit">
            <label for="strokeLineJoint">Stroke Line Joint:</label>
            <!-- <input type="text" value="{{strokeLineJoint::input}}" id="strokeLineJoint"> -->
            <select id="strokeLineJoint" class="strokeLineJoint" value="{{strokeLineJoint::input}}">
              <option value="bevel">Bevel</option>
              <option value="round">Round</option>
              <option value="miter">Miter</option>
            </select>
            <br/>
          </div>
          <div id="strokeMiterLimitEdit">
            <label for="strokeMiterLimit">Stroke Miter Limit:</label>
            <input type="number" value="{{strokeMiterLimit::input}}" min="0" max="150" id="strokeMiterLimit">
            <input type="range" value="{{strokeMiterLimit::input}}" min="0" max="150" id="strokeMiterLimitRange">
            <br/>
          </div>
          <div id="opacityEdit">
            <label for="opacity">Opacity:</label>
            <input type="number" value="{{opacity::input}}" min="0" max="1" step="0.10" id="opacity">
            <input type="range" value="{{opacity::input}}" min="0" max="1" step="0.10" id="opacityRange">
            <br/>
          </div>
          <div id="fillRuleEdit">
            <label for="fillRule">Fill Rule:</label>
            <!-- <input type="text" value="{{fillRule::input}}" id="fillRule"> -->
            <select id="fillRule" class="fillRule" value="{{fillRule::input}}">
              <option value="nonzero">nonzero</option>
              <option value="evenodd" selected>evenodd</option>
            </select>
            <br/>
          </div>
          <div id="globalCompositeOperationEdit">
            <label for="globalCompositeOperation">Global Composite Operation:</label>
            <!-- <input type="text" value="{{globalCompositeOperation::input}}" id="globalCompositeOperation"> -->
            <select id="globalCompositeOperation" class="globalCompositeOperation" value="{{globalCompositeOperation::input}}">
              <option value="source-over">Source-Over</option>
            </select>
            <br/>
          </div>
          <div id="clipToEdit">
            <label for="clipTo">Clip To:</label>
            <input type="text" value="{{clipTo::input}}" id="clipTo">
            <br/>
          </div>
          <div id="visibleEdit">
            <label for="visible">Visible</label>
            <!-- <input type="text" value="{{visible::input}}" id="visible"> -->
            <input type="button" value="{{visible::input}}" id="visible">
            <br/>
          </div>
          <div id="skewXEdit">
            <label for="skewX">SkewX:</label>
            <input type="number" value="{{skewX::input}}" min="0" max="150" id="skewX">
            <input type="range" value="{{skewX::input}}" min="0" max="150" id="skewXRange">
            <br/>
          </div>
          <div id="skewYEdit">
            <label for="skewY">SkewY:</label>
            <input type="number" value="{{skewY::input}}" min="0" max="150" id="skewY">
            <input type="range" value="{{skewY::input}}" min="0" max="150" id="skewYRange">
            <br/>
          </div>
          <div id="rxEdit">
            <label for="rx">rx:</label>
            <!-- <input type="text" value="{{rx::input}}" id="rx"> -->
            <input type="number" value="{{rx::input}}" min="0" max="150" id="rx">
            <input type="range" value="{{rx::input}}" min="0" max="150" id="rxRange">
            <br/>
          </div>
          <div id="ryEdit">
            <label for="ry">ry:</label>
            <!-- <input type="text" value="{{ry::input}}" id="ry"> -->
            <input type="number" value="{{ry::input}}" min="0" max="150" id="ry">
            <input type="range" value="{{ry::input}}" min="0" max="150" id="ryRange">
            <br/>
          </div>
          <div id="sEdit">
            <label for="x">x:</label>
            <input type="text" value="{{x::input}}" id="x">
            <br/>
          </div>
          <div id="yEdit">
            <label for="y">y:</label>
            <input type="text" value="{{y::input}}" id="y">
            <br/>
          </div>
          <div id="alignXEdit">
            <label for="alignX">AlignX:</label>
            <input type="text" value="{{alignX::input}}" id="alignX">
            <select id="alignX" class="alignX" value="{{alignX::input}}">
              <option value="none">None</option>
              <option value="mid">Mid</option>
              <option value="min">Min</option>
            </select>
            <br/>
          </div>
          <div id="alignYEdit">
            <label for="alignY">AlignY:</label>
            <input type="text" value="{{alignY::input}}" id="alignY">
            <select id="alignY" class="alignY" value="{{alignY::input}}">
              <option value="none">None</option>
              <option value="mid">Mid</option>
              <option value="min">Min</option>
            </select>
            <br/>
          </div>
          <div id="meetOrSliceEdit">
            <label for="meetOrSlice">Meet or Slice:</label>
            <input type="text" value="{{meetOrSlice::input}}" id="meetOrSlice">
            <select id="meetOrSlice" class="meetOrSlice" value="{{meetOrSlice::input}}">
              <option value="meet">Meet</option>
              <option value="slice">Slice</option>
            </select>
            <br/>
          </div>
          <div id="groupEdit">
            <p>
              <button class="btn btn-object-action" id="removeSelected">
                  Remove selected object or group
              </button>
              <br/>
              <button class="btn btn-object-action" id="groupSelected">
                  Group selected objects
              </button>
              <br/>
              <button class="btn btn-object-action" id="ungroupSelected">
                  Ungroup selected group
              </button>
            </p>
          </div>

        <div id="positionEdit">
          <div style="margin-top:10px;">
            <button id="send-backwards" class="btn btn-object-action">Send backwards</button>
            <button id="send-to-back" class="btn btn-object-action">Send to back</button>
          </div>
          <div style="margin-top:4px;">
            <button id="bring-forward" class="btn btn-object-action">Bring forwards</button>
            <button id="bring-to-front" class="btn btn-object-action">Bring to front</button>
          </div>
        </div>
        <div id="lockEdit">
            <p>
                  <label>Locks</label>
                  <br/>
                  <button class="btn" value="{{lockMovementX::input}}" id="lockMovementX">Horizontal Movement</button>
                  <button class="btn" value="{{lockMovementY::input}}" id="lockMovementY">Vertical Movement</button>
                  <br>
                  <button class="btn" value="{{lockScalingX::input" id="lockScalingX">Horizontal Scaling</button>
                  <button class="btn" value="{{lockScalingY::input}}" id="lockScalingY">Vertical Scaling</button>
                  <br>
                  <button class="btn" value="{{lockSkewingX::input}}" id="lockSkewingX">Horizontal Skewing</button>
                  <button class="btn" value="{{lockSkewingY::input}}" id="lockSkewingY">Vertical Skewing</button>
                  <br>
                  <button class="btn" value="{{lockRotation::input}}" id="lockRotation">Rotation</button>
                  <button class="btn" value="{{lockScalingFlip::input}}" id="lockScalingFlip">Flip</button>
                  <button class="btn" value="{{lockUniScaling::input}}" id="lockUniScaling">Uni Scaling</button>
            </p>
        </div>
      </div>

  </template>

  <script>

    // debug levels
    const ALL = 0;
    const TRACE = 1;
    const DEBUG = 2;
    const ERROR = 3;
    const WARNING = 4
    const STATUS = 5;
    const INFO = 6;

    // canvas position
    const BACKGROUND = -1;
    const OBJECT = 0;
    const ELEMENT = 0;
    const CANVAS = 1;



    class Polymer2FabricEdit extends Polymer.Element {
      static get is() { return 'polymer-2-fabric-edit' }
      static get config() {
        return {
          properties: {
            logLevel: {
              type: Number,
              value: 5
            },
            canvas: {
              type: Object,
              value: null
            },
            ctx: {
              type: Object,
              value: null
            },
            canvasWidth: {
              type: Number,
              value: 300,
              notify: true
            },
            canvasHeight: {
              type: Number,
              value: 300,
              notify: true,
            },
            canvasBackgroundColor: {
              type: String,
              observer: 'canvasBackgroundColorChange',
              value: '#FFFFFF',
              notify: true
            },
            canvasBorderColor: {
              type: String,
              //observer: 'handleCanvasBorderColorChange',
              value: 'blue'
            },
            history: {
              type: Array,
              value: [],
            },
            selectedMenu: {
              type: String,
              value: "none",
              notify: true
            },
            drawingMode: {
              type: String,
              value: "Cancel",
              notify: true
            },
            downloadFileNamePrefix: {
              type: String,
              value: "canvas",
              notify:true
            },
            downloadFileExtension: {
              type: String,
              value: "json",
              notify:true
            },
            drawingTool: {
                type: String,
                value: "Pencil",
                observer: 'drawingToolChange',
                notify: true
            },
            brushTexture: {
                type: String,
                value: "honey_im_subtle",
                observer: 'brushTextureChange',
                notify: true
            },
            brushWidth: {
              type: Number,
              value: 5,
              observer: 'brushWidthChange',
              notify: true
            },
            brushOpacity: {
              type: Number,
              value: 0.6,
              observer: 'brushOpacityChange',
              notify: true
            },
            brushDensity: {
              type: Number,
              value: 10,
              observer: 'brushDensityChange',
              notify: true
            },
            brushDotWidth: {
              type: Number,
              value: 1,
              observer: 'brushDotWidthChange',
              notify: true
            },
            brushDotWidthVariance: {
              type: Number,
              value: 1,
              observer: 'brushDotWidthVarianceChange',
              notify: true
            },
            brushColor: {
                type: String,
                value: "#00000",
                observer: 'brushColorChange',
                notify: true
            },
            brushShadowColor: {
                type: String,
                value: "#FFFFFF",
                observer: 'brushShadowColorChange',
                notify: true
            },
            brushShadowBlur: {
                type: Number,
                value: 0,
                observer: 'brushShadowBlurChange',
                notify: true
            },
            brushShadowOffsetX: {
                type: Number,
                value: 0,
                observer: 'brushShadowOffsetXChange',
                notify: true
            },
            brushShadowOffsetY: {
                type: Number,
                value: 0,
                observer: 'brushShadowOffsetYChange',
                notify: true
            },
            hideText: {
              type: Boolean,
              value: true,
              notify:true
            },
            hideShape: {
              type: Boolean,
              value: true,
              notify:true
            },
            hideFile: {
              type: Boolean,
              value: true,
              notify:true
            },
            hideDraw: {
              type: Boolean,
              value: true,
              notify:true
            },
            hideControl: {
              type: Boolean,
              value: true,
              notify:true
            },
            hideBrushTexture: {
                type: Boolean,
                value: true,
                notify: true
            },
            hideBrushTextureUpload: {
                type: Boolean,
                value: true,
                notify: true
            },
            hideBrushOpacity: {
                type: Boolean,
                value: true,
                notify: true
            },
            hideBrushSpray: {
                type: Boolean,
                value: true,
                notify: true
            },
            lockMovementX: {
              type: Boolean,
              value: false,
              notify:true
            },
            lockMovementY: {
              type: Boolean,
              value: false,
              notify:true
            },
            lockRotation: {
              type: Boolean,
              value: false,
              notify:true
            },
            lockScalingFlip: {
              type: Boolean,
              value: false,
              notify:true
            },
            lockScalingX: {
              type: Boolean,
              value: false,
              notify:true
            },
            lockScalingY: {
              type: Boolean,
              value: false,
              notify:true
            },
            lockSkewingX: {
              type: Boolean,
              value: false,
              notify:true
            },
            lockSkewingY: {
              type: Boolean,
              value: false,
              notify:true
            },
            lockUniScaling: {
              type: Boolean,
              value: false,
              notify:true
            },
            bold: {
                type: Boolean,
                value: false,
                observer: 'boldChange',
                notify: true
            },
            italic: {
                type: Boolean,
                value: false,
                observer: 'italicChange',
                notify: true
            },
            underline: {
              type: Boolean,
              value: false,
              observer: 'underlineChange',
              notify: true
            },
            linethrough: {
              type: Boolean,
              value: false,
              observer: 'linethroughChange',
              notify: true
            },
            overline: {
              type: Boolean,
              value: false,
              observer: 'overlineChange',
              notify: true
            },
            top: {
              type: Number,
              value: 0,
              observer: 'topChange',
              notify: true
            },
            left: {
              type: Number,
              value: 0,
              observer: 'leftChange',
              notify: true
            },
            width: {
              type: Number,
              value: 0,
              observer: 'widthChange',
              notify: true
            },
            height: {
              type: Number,
              value: 0,
              observer: 'heightChange',
              notify: true
            },
            scaleX: {
              type: Number,
              value: 0,
              observer: 'scaleXChange',
              notify: true
            },
            scaleY: {
              type: Number,
              value: 0,
              observer: 'scaleYChange',
              notify: true
            },
            flipX: {
              type: Boolean,
              value: false,
              observer: 'flipXChange',
              notify: true
            },
            flipY: {
              type: Boolean,
              value: false,
              observer: 'flipYChange',
              notify: true
            },
            originX: {
              type: "String",
              value: "center",
              observer: 'origionXChange',
              notify: true
            },
            originY: {
              type: "String",
              value: "center",
              observer: 'origionYChange',
              notify: true
            },
            transformMatrix: {
              type: Array,
              value: [],
              observer: 'transformMatrixChange',
              notify: true
            },
            stroke: {
              type: String,
              value: "#000000",
              observer: 'strokeChange',
              notify: true
            },
            strokeWidth: {
              type: Number,
              value: 1,
              observer: 'strokeWidthChange',
              notify: true
            },
            strokeDashArray: {
              type: Array,
              value: [0],
              observer: 'strokeDashArrayChange',
              notify: true
            },
            strokeLineStyle: {
              type: String,
              value: "solid",
              observer: 'strokeLineStyleChange',
              notify: true
            },
            strokeLineCap: {
              type: String,
              value: "butt",
              observer: 'strokeLineCapChange',
              notify: true
            },
            strokeLineJoint: {
              type: String,
              value: "bevil",
              observer: 'strokeLineJointChange',
              notify: true
            },
            strokeMiterLimit: {
              type: Number,
              value: 0,
              observer: 'strokeMiterLimitChange',
              notify: true
            },
            angle: {
              type: Number,
              value: 0,
              observer: 'angleChange',
              notify: true
            },
            opacity: {
              type: Number,
              value: 0,
              observer: 'opacityChange',
              notify: true
            },
            fill: {
              type: String,
              value: "#000000",
              observer: 'fillChange',
              notify: true
            },
            fillRule: {
              type: String,
              value: "",
              observer: 'fillRuleChange',
              notify: true
            },
            globalCompositeOperation: {
              type: String,
              value: "",
              observer: 'globalCompositeOperationChange',
              notify: true
            },
            shadow: {
              value: {},
              observer: 'shadowChange',
              notify: true
            },
            shadowColor: {
              type: String,
              value: "#000000",
              observer: 'shadowColorChange',
              notify: true
            },
            shadowBlur: {
              type: Number,
              value: 0,
              observer: 'shadowBlurChange',
              notify: true
            },
            shadowOffsetX: {
              type: Number,
              value: 0,
              observer: 'shadowOffsetXChange',
              notify: true
            },
            shadowOffsetY: {
              type: Number,
              value: 0,
              observer: 'shadowOffsetYChange',
              notify: true
            },
            clipTo: {
              type: Function,
              value: "",
              observer: 'clipToChange',
              notify: true
            },
            visible: {
              type: Boolean,
              value: true,
              observer: 'visibleChange',
              notify: true
            },
            skewX: {
              type: Number,
              value: 0,
              observer: 'skewXChange',
              notify: true
            },
            skewY: {
              type: Number,
              value: 0,
              observer: 'skewYChange',
              notify: true
            },
            fontFamily: {
              type: String,
              value: "arial",
              observer: 'fontFamilyChange',
              notify: true
            },
            fontWeight: {
              type: String,
              value: "normal",
              observer: 'fontWeightChange',
              notify: true
            },
            fontSize: {
              type: Number,
              value: 20,
              observer: 'fontSizeChange',
              notify: true
            },
            text: {
              type: String,
              value: "",
              ///observer: 'textChange',
              notify: true
            },
            textAlign: {
              type: "String",
              value: "left",
              observer: 'textAlignChange',
              notify: true
            },
            textDecoration: {
              type: "String",
              value: "",
              observer: 'textDecorationChange',
              notify: true
            },
            fontStyle: {
              type: String,
              value: "",
              observer: 'fontStyleChange',
              notify: true
            },
            lineHeight: {
              type: Number,
              value: 1,
              observer: 'lineHeightChange',
              notify: true
            },
            charSpacing: {
              type: Number,
              value: 1,
              observer: 'charSpacingChange',
              notify: true
            },
            backgroundColor: {
              type: String,
              value: "#FFFFFF",
              observer: 'backgroundColorChange',
              notify: true
            },
            textBackgroundColor: {
                type: String,
                value: "#FFFFFF",
                observer: 'textBackgroundColorChange',
                notify: true
            },
            alignX: {
              type: String,
              value: "none",
              observer: 'alignXChange',
              notify: true
            },
            alignY: {
              type: String,
              value: "none",
              observer: 'alignYChange',
              notify: true
            },
            meetOrSlice: {
              type: String,
              value: "meet",
              observer: 'meetOrSliceChange',
              notify: true
            },
            rx: {
              type: String,
              value: "none",
              observer: 'rxChange',
              notify: true
            },
            ry: {
              type: String,
              value: "none",
              observer: 'rxChange',
              notify: true
            },
            x: {
              type: String,
              value: "none",
              observer: 'xChange',
              notify: true
            },
            y: {
              type: Number,
              value: "none",
              observer: 'yChange',
              notify: true
            }

          },
          observers: [
           ]
        }
      }
      constructor() {
        super();
        this.log(TRACE,'constructer');
      }
      connectedCallback() {
        super.connectedCallback();
        this.log(TRACE,'connectedCallback');
      }
      ready() {
        this.log(TRACE,'ready');
        super.ready();
        this.canvas = new fabric.Canvas(this.$.c, {isDrawingMode: false});
        fabric.Object.prototype.objectCaching = false;
        this.log(DEBUG,"canvas:",this.canvas);
        this.ctx = this.canvas.getContext('2d');
        this.addEventListener('click', (e)=>this.handleClick(e));
        //this.addEventListener('mousemove', (e)=>this.handleClick(e));
        this.addEventListener('change', (e)=>this.handleChange(e));
        this.addEventListener('keyup', (e)=>this.handleKeyUp(e));
        this.$.dropObjectDiv.addEventListener("dragover", (e)=>this.preventEventDefault(e));
        this.$.dropObjectDiv.addEventListener("drop", (e)=>this.loadDropedFile(e));
        this.$.dropBackgroundDiv.addEventListener("dragover", (e)=>this.preventEventDefault(e));
        this.$.dropBackgroundDiv.addEventListener("drop", (e)=>this.loadDropedBackgroundFile(e));
        this.$.dropCanvasDiv.addEventListener("dragover", (e)=>this.preventEventDefault(e));
        this.$.dropCanvasDiv.addEventListener("drop", (e)=>this.loadDropedCanvasFile(e));
        this.$.objectLoader.addEventListener("change", (e)=>this.loadSelectedFile(e));
        this.$.canvasLoader.addEventListener("change", (e)=>this.loadCanvasFile(e));
        this.$.backgroundLoader.addEventListener("change", (e)=>this.loadBackgroundFile(e));
        this.$.brushTextureobjectLoader.addEventListener("drop", (e)=>this.loadDropedBrushTextureFile(e));
        this.$.brushTextureobjectLoader.addEventListener("change", (e)=>this.loadBrushTextureFile(e));
        this.log(9,'ready');
      }
      preventEventDefault(e) {
        this.log(TRACE,"preventEventDefault");
        e.preventDefault();
      }
      handleChange(e) {
        this.log(TRACE,"handleChange");
        var id = e.path[0].id;
        this.log(DEBUG,"event type:", e.type, "tag name:", e.currentTarget.tagName, "id:", id, "event:", e);

      }
      handleKeyUp(e) {
        this.log(TRACE,"handleKeyUp");
        var id = e.path[0].id;
        this.log(DEBUG,"event type:", e.type, "tag name:", e.currentTarget.tagName, "id:", id, "event:", e);
        if(this.canvas) {
          var obj = this.canvas.getActiveObject();
          if(obj && (obj.type === "i-text" || obj.type === "text")) {
            switch(id) {
              case 'text':
              case 'itext':
                obj.setText(this.$[id].value);
                this.canvas.renderAll();
                break;
            }
          }
        }
      }
      handleClick(e) {
        this.log(TRACE,"handleClick");
        var id = e.path[0].id;
        this.log(DEBUG,"event type:", e.type, "tag name:", e.currentTarget.tagName, "id:", id, "event:", e);
        switch(id) {
            case '':
              var target = e.target;
              var obj = this.canvas.getActiveObject();
              this.log(DEBUG,"No ID - This is mostlike a selet of an object");
              this.log(DEBUG,"target:" + target, "selected Object:" + obj, "selected Menu: " + this.selectedMenu);
              switch(this.selectedMenu) {
                case 'text':
                  this.loadTextView();
                  break;
                case 'file':
                  this.loadFileView();
                  break;
                case 'shape':
                  this.loadShapeView();
                  break;
                case 'draw':
                  this.loadDrawView();
                  break;
                case 'control':
                  this.loadControlView();
                  break;
              }
              break;
            case 'textButton':
              this.loadTextView();
              break;
            case 'shapeButton':
              this.loadShapeView();
            break;
            case 'fileButton':
              this.loadFileView();
              break;
            case 'drawButton':
              this.showMenu("draw");
              this.canvas.isDrawingMode = true;
              this.drawingToolChange("INIT",null);
              this.drawingMode = "Cancel";
              break;
            case 'controlButton':
              this.loadControlView();
              break;
          case 'bold':
            this.bold = this.toggleActive(id, this.bold);
            break;
          case 'italic':
            this.italic = this.toggleActive(id, this.italic);
            break;
          case 'underline':
            this.underline = this.toggleActive(id, this.underline);
            break;
          case 'linethrough':
            this.linethrough = this.toggleActive(id, this.linethrough);
            break;
          case 'overline':
            this.overline = this.toggleActive(id, this.overline);
            break;
          case 'drawingTool':
            this.canvas.isDrawingMode = !this.canvas.isDrawingMode;
            this.drawingMode = this.canvas.isDrawingMode ? "Cancel" : "Enter";
            break;
          case 'clearCanvas':
            var canvas_objects = this.canvas._objects;
            while(canvas_objects.length !== 0) {
              var last = canvas_objects[canvas_objects.length -1];
              this.history.push(last);
              this.canvas.remove(last);
            }
            this.canvas.renderAll();
            break;
          case 'undoCanvas':
            var canvas_objects = this.canvas._objects;
            if(canvas_objects.length !== 0){
              var last = canvas_objects[canvas_objects.length -1];
              this.history.push(last);
              this.canvas.remove(last);
              this.canvas.renderAll();
            }
            break;
            case 'redoCanvas':
              if(this.history.length !== 0){
                this.canvas.add(this.history.pop());
                this.canvas.renderAll();
              }
              break;
            case 'restoreCanvas':
            while(this.history.length !== 0){
              this.canvas.add(this.history.pop());
              this.canvas.renderAll();
            }
            this.canvas.renderAll();
            break;
          case 'addText':
            this.log(DEBUG,"text:",this.$.text.value);
            var textShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.offsetX + "px " + this.offsetY + "px";
            var textDecoration = "";
            if (this.$.underline.classList.contains('active')) {
              textDecoration += "underline ";
            }
            if (this.$.linethrough.classList.contains('active')) {
              textDecoration += "line-through ";
            }
            if (this.$.overline.classList.contains('active')) {
              textDecoration += "overline";
            }
            var text = new fabric.IText(this.$.text.value, {
                fontFamily: this.fontFamily,
                backgroundColor: this.backgroundColor,
                textBackgroundColor: this.textBackgroundColor,
                fill: this.fill,
                fontSize: this.fontSize,
                fontWeight: this.$.bold.classList.contains('active') ? 'bold' : 'normal',
                fontStyle: this.$.italic.classList.contains('active') ? 'italic' : '',
                textAlign: this.textAlign.toLowerCase(),
                charSpacing: this.charSpacing,
                textDecoration: textDecoration,
                stroke: this.stroke,
                strokeWidth: this.strokeWIdth,
                shadow: textShadow,
                top: e.offsetY,
                left: e.offsetX,
                selectable: true
            });
            this.canvas.add(text);
            this.canvas.centerObject(text);
            this.canvas.renderAll();
            text.setCoords();
            break;
          case 'flipX':
            this.flipX = ! this.flipX;
            break;
          case 'flipY':
            this.flipY = ! this.flipY;
            break;
          case 'visible':
              this.visible = ! this.visible;
              break;
          case 'shapeSquare':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var square = new fabric.Rect({
              left: 100,
              top: 100,
              width: 100,
              height: 100,
              fill: this.fill,
              shadow: shapeShadow,
              stroke: this.stroke,
              strokeWidth: this.strokeWidth,
              strokeDashArray: eval(this.strokeDashArray)
            });
            this.canvas.add(square);
            this.canvas.centerObject(square);
            this.canvas.renderAll();
            square.setCoords();
            break;
          case 'shapeRectangle':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var rect = new fabric.Rect({
              left: 100,
              top: 100,
              width: 100,
              height: 50,
              fill: this.fill,
              shadow: shapeShadow,
              stroke: this.stroke,
              strokeWidth: this.strokeWidth,
              strokeDashArray: eval(this.strokeDashArray)
              //angle: this.strokeAngle
            });
            this.canvas.add(rect);
            this.canvas.centerObject(rect);
            this.canvas.renderAll();
            rect.setCoords();
            break;
          case 'shapeDiamond':
              var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
              this.angle = 45;
              var diamond = new fabric.Rect({
                left: 100,
                top: 100,
                width: 100,
                height: 100,
                fill: this.fill,
                shadow: shapeShadow,
                stroke: this.stroke,
                strokeWidth: this.strokeWidth,
                strokeDashArray: eval(this.strokeDashArray),
                angle: this.angle
              });
              this.canvas.add(diamond);
              this.canvas.centerObject(diamond);
              this.canvas.renderAll();
              diamond.setCoords();
              break;
          case 'shapeCircle':
              var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
              var circle = new fabric.Circle({
                left: 100,
                top: 100,
                radius: 75,
                fill: this.fill,
                shadow: shapeShadow,
                stroke: this.stroke,
                strokeWidth: this.strokeWidth,
                strokeDashArray: eval(this.strokeDashArray)
              });
              this.canvas.add(circle);
              this.canvas.centerObject(circle);
              this.canvas.renderAll();
              circle.setCoords();
              break;
          case 'shapeEllipse':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var ellipse = new fabric.Ellipse({
              rx: 45,
              ry: 80,
              fill: this.fill,
              shadow: shapeShadow,
              stroke: this.stroke,
              strokeWidth: this.strokeWidth,
              strokeDashArray: eval(this.strokeDashArray),
              angle: 30,
              left: 100,
              top: 100
            });

            this.canvas.add(ellipse);
            this.canvas.centerObject(ellipse);
            this.canvas.renderAll();
            ellipse.setCoords();
            break;
          case 'shapeTriangle':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var triangle = new fabric.Triangle({
              left: 100,
              top: 100,
              width: 70,
              height: 70,
              fill: this.fill,
              shadow: shapeShadow,
              stroke: this.stroke,
              strokeWidth: this.strokeWidth,
              strokeDashArray: eval(this.strokeDashArray)
            });
            this.canvas.add(triangle);
            this.canvas.centerObject(triangle);
            this.canvas.renderAll();
            triangle.setCoords();
            break;
          case 'shapeVerticleLine':
          case 'shapeHorizontalLine':
          case 'shapeDiagnalLine':
          case 'angledLine':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            switch(id) {
              case 'shapeVerticleLine':
                this.angle = 0;
                break;
              case 'shapeHorizontalLine':
                this.angle = 90;
                break;
              case 'shapeDiagnalLine':
                this.angle = 135;
                break;
              case 'angledLine':
            }
            var angledLine = new fabric.Line([10, 10, 10, 200], {
              fill: this.fill,
              shadow: shapeShadow,
              stroke: this.stroke,
              strokeWidth: this.strokeWidth,
              angle: this.angle,
              strokeDashArray: eval(this.strokeDashArray)
            });
            this.canvas.add(angledLine);
            this.canvas.centerObject(angledLine);
            this.canvas.renderAll();
            angledLine.setCoords();
            break;
          case 'shapePolygon':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var pol = new fabric.Polygon([
              {x: 200, y: 0},
              {x: 250, y: 50},
              {x: 250, y: 100},
              {x: 150, y: 100},
              {x: 150, y: 50} ], {
                left: 10,
                top: 10,
                angle: 0,
                fill: this.fill,
                shadow: shapeShadow,
                stroke: this.stroke,
                strokeWidth: this.strokeWidth,
                strokeDashArray: eval(this.strokeDashArray)
              }
            );
            this.canvas.add(pol);
            this.canvas.centerObject(pol);
            this.canvas.renderAll();
            pol.setCoords();
            break;
          case 'shapePolyline':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var poly = new fabric.Polyline([
              { x: 10, y: 10 },
              { x: 50, y: 30 },
              { x: 40, y: 70 },
              { x: 60, y: 50 },
              { x: 100, y: 150 },
              { x: 40, y: 100 }
              ], {
                fill: this.fill,
                shadow: shapeShadow,
                stroke: this.stroke,
                strokeWidth: this.strokeWidth,
                strokeDashArray: eval(this.strokeDashArray)
            });
            this.canvas.add(poly);
            this.canvas.centerObject(poly);
            this.canvas.renderAll();
            poly.setCoords();
            break;
          case 'shapeHexagon':  // make a hexagon
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var points=this.regularPolygonPoints(6,30);
            var myPoly = new fabric.Polygon(points, {
              fill: this.fill,
              shadow: shapeShadow,
              stroke: this.stroke,
              strokeWidth: this.strokeWidth,
              strokeDashArray: eval(this.strokeDashArray),
              left: 10,
              top: 10,
              strokeLineJoint: 'bevil'
            },false);
            this.canvas.add(myPoly);
            this.canvas.centerObject(myPoly);
            this.canvas.renderAll();
            myPoly.setCoords();
            break;
          case 'shapeStar':  // make a star
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var points=this.starPolygonPoints(5,50,25);
            var star = new fabric.Polygon(points, {
              fill: this.fill,
              shadow: shapeShadow,
              stroke: this.stroke,
              strokeWidth: this.strokeWidth,
              strokeDashArray: eval(this.strokeDashArray),
              left: 10,
              top: 10,
              strokeLineJoint: 'bevil'
            },false);
            this.canvas.add(star);
            this.canvas.centerObject(star);
            this.canvas.renderAll();
            star.setCoords();
            break;
          case 'shapeArrow':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var path = new fabric.Path('M121.32,0L44.58,0C36.67,0,29.5,3.22,24.31,8.41\
              c-5.19,5.19-8.41,12.37-8.41,20.28c0,15.82,12.87,28.69,28.69,28.69c0,0,4.4,\
              0,7.48,0C36.66,72.78,8.4,101.04,8.4,101.04C2.98,106.45,0,113.66,0,121.32\
              c0,7.66,2.98,14.87,8.4,20.29l0,0c5.42,5.42,12.62,8.4,20.28,8.4c7.66,0,14.87\
              -2.98,20.29-8.4c0,0,28.26-28.25,43.66-43.66c0,3.08,0,7.48,0,7.48c0,15.82,\
              12.87,28.69,28.69,28.69c7.66,0,14.87-2.99,20.29-8.4c5.42-5.42,8.4-12.62,8.4\
              -20.28l0-76.74c0-7.66-2.98-14.87-8.4-20.29C136.19,2.98,128.98,0,121.32,0z');
              this.canvas.add(path.set({ left: 10, top: 10 }));
              this.canvas.centerObject(path);
            var last = canvasObjects[canvasObjects.length -1]; //Get last object
            last.setShadow(shapeShadow);
            this.canvas.centerObject(last);
            this.canvas.renderAll();
            last.setCoords();
            break;
          case 'shapeLineArrow':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var linePoints = [10, 20, 100, 20];
            var line = new fabric.Line(linePoints, {
              fill: this.fill,
              shadow: shapeShadow,
              stroke: this.stroke,
              strokeWidth: this.strokeWidth,
              strokeDashArray: eval(this.strokeDashArray),
              originX: 'center',
              originY: 'center',
              hasControls: false,
              hasBorders: false,
              hasRotatingPoint: false,
              hoverCursor: 'default',
              selectable: false
            });
            var arrow = this.createArrowHead(linePoints);
            arrow.setShadow(shapeShadow);
            var group = new fabric.Group([line, arrow]);
            group.setShadow(shapeShadow);
            this.canvas.add(group);
            this.canvas.centerObject(group);
            this.canvas.renderAll();
            group.setCoords();
            break;
          case 'shapeAnchor':
            var shapeShadow = this.shadowColor + " " + this.shadowBlur + "px " + this.shadowOffsetX + "px " + this.shadowOffsetY + "px";
            var json = '{"objects":[{"type":"path","left":104,"top":96,"width":99,"height":115,"fill":"#00274D","overlayFill":null,"stroke":null,"strokeWidth":1,"scaleX":1.04,"scaleY":1.04,"angle":-25.8,"flipX":false,"flipY":false,"opacity":1,"selectable":true,"path":[["M",67.39,22.39],["c",2.59,-0.43,5.11,1.44,5.54,4.18],["c",0.43,2.66,-1.3,5.26,-3.89,5.69],["c",-1.8,0.29,-3.6,-0.58,-4.61,-2.02],["L",44.5,34.56],["l",10.87,59.62],["c",17.42,-4.46,26.06,-14.18,27.5,-29.02],["l",-10.01,-0.72],["L",88.7,51.91],["l",9.43,21.24],["c",-3.38,-1.95,-5.9,-5.11,-9.29,-7.06],["c",-0.29,25.06,-27.14,32.76,-33.77,47.95],["C",44.42,100.08,26.5,114.77,6.91,82.8],["L",0,92.45],["l",1.51,-21.6],["l",19.66,4.68],["l",-9.43,3.67],["c",7.49,11.59,17.57,19.87,36.43,16.42],["L",36.22,36.57],["l",-18.65,2.38],["c",-0.14,2.16,-1.73,4.03,-3.89,4.39],["c",-2.59,0.43,-5.04,-1.44,-5.54,-4.1],["c",-0.43,-2.74,1.3,-5.26,3.89,-5.69],["c",1.94,-0.36,3.89,0.65,4.9,2.3],["l",17.93,-4.82],["l",-1.37,-6.84],["c",-4.82,-0.79,-8.93,-4.75,-9.79,-10.08],["c",-1.15,-6.62,3.1,-12.89,9.43,-13.97],["c",6.41,-1.01,12.46,3.46,13.54,10.08],["c",0.86,5.18,-1.58,10.15,-5.69,12.6],["l",1.87,6.12],["l",20.74,-2.88],["C",64.01,24.26,65.52,22.75,67.39,22.39],["L",67.39,22.39],["z"],["M",33.91,5.18],["c",-3.46,0.58,-5.76,3.96,-5.11,7.56],["c",0.58,3.6,3.89,6.05,7.27,5.47],["c",3.46,-0.58,5.76,-3.96,5.18,-7.56],["C",40.61,7.05,37.37,4.61,33.91,5.18],["z"]]}],"background":"rgba(0, 0, 0, 0)"}';
            this.canvas.loadFromDatalessJSON(json);
            var canvasObjects = this.canvas._objects;
            var last = canvasObjects[canvasObjects.length -1]; //Get last object
            last.setShadow(shapeShadow);
            this.log(7,"shapelastObject:",last);
            this.canvas.centerObject(last);
            this.canvas.renderAll();
            last.setCoords();
            break;
          case 'removeSelected':
            this.canvas.getActiveObject().remove();
            this.canvas.renderAll();
            break;
          case 'send-backwards':
            var activeObject = this.canvas.getActiveObject();
            if(activeObject) {
              this.canvas.sendBackwards(activeObject);
              this.canvas.discardActiveObject();
              this.canvas.renderAll();
              activeObject.setCoords();
            }
            break;
          case 'send-to-back':
            var activeObject = this.canvas.getActiveObject();
            if(activeObject) {
              this.canvas.sendToBack(activeObject);
              this.canvas.discardActiveObject();
              this.canvas.renderAll();
              activeObject.setCoords();
            }
            break;
          case 'bring-forward':
            var activeObject = this.canvas.getActiveObject();
            if(activeObject) {
              this.canvas.bringForward(activeObject);
              this.canvas.discardActiveObject();
              this.canvas.renderAll();
              activeObject.setCoords();
            }
            break;
          case 'bring-to-front':
            var activeObject = this.canvas.getActiveObject();
            if(activeObject) {
              this.canvas.bringToFront(activeObject);
              this.canvas.discardActiveObject();
              this.canvas.renderAll();
              activeObject.setCoords();
            }
            break;
          case 'top':
          case 'topRange':
              break;
          case 'fillText':
          case 'fill':
              break;
          case 'lockMovementX':
          case 'lockMovementY':
          case 'lockRotation':
          case 'lockScalingFlip':
          case 'lockScalingX':
          case 'lockScalingY':
          case 'lockSkewingX':
          case 'lockSkewingY':
          case 'lockUniScaling':
              var element = this.$[id];
              var obj = this.canvas.getActiveObject();
              var oldValue = obj.get(id);
              var value = !oldValue;
              element.value = value;
              this[id + ""] = value;
              obj.set(id, value);
              if(value === true) {
                element.classList.add('active');
              } else {
                element.classList.remove('active');
              }
              break;
          case 'downloadCanvas':
              this.downloadCanvas(e);
              break;
            //case 'downloadAsImage':
            //  this.downloadAsImage(e);
            //  break;
            //case 'downloadAsJSON':
            //  this.downloadAsJSON(e);
            //  break;
          default:
        }
      }
      drawingToolChange(newValue, oldValue) {
          this.log(TRACE,"drawingToolChange");
          this.log(DEBUG, "change from ", oldValue, " to ", newValue);
          this.hideBrushTexture = (newValue !== "Texture");
          if(newValue === "brushTexture") {
              this.hideBrushTextureUpload = this.brushTexture !== "Custom";
          } else {
              this.hideBrushTextureUpload = true;
          }
          this.hideBrushOpacity = true;
          this.hideBrushSpray = true;
          if(this.canvas) {
              switch(newValue) {
                  case 'Crayon':
                    this.canvas.freeDrawingBrush = new fabric.CrayonBrush(this.canvas, { opacity: this.brushOpacity });
                    this.hideBrushOpacity = false;
                    break;
                  case 'Pen':
                    this.canvas.freeDrawingBrush = new fabric.InkBrush(this.canvas, { opacity: this.brushOpacity });
                    this.hideBrushOpacity = false;
                    break;
                  case 'Marker':
                      this.canvas.freeDrawingBrush = new fabric.MarkerBrush(this.canvas, { opacity: this.brushOpacity });
                      this.hideBrushOpacity = false;
                      break;
                  case 'Circle':
                    this.canvas.freeDrawingBrush = new fabric.CircleBrush(this.canvas);
                    break;
                  case 'Sprayer':
                    this.canvas.freeDrawingBrush = new fabric.SprayerBrush(this.canvas, { opacity: this.brushOpacity });
                    this.hideBrushOpacity = false;
                    break;
                    case 'Spray':
                        this.canvas.freeDrawingBrush = new fabric.SprayBrush(this.canvas);
                        this.hideBrushSpray = false;
                        break;
                    case 'FineSpray':
                        this.canvas.freeDrawingBrush = new fabric.SprayBrush(this.canvas);
                        this.canvas.freeDrawingBrush.density = 1;
                        this.canvas.freeDrawingBrush.dotWidth = 1;
                        this.canvas.freeDrawingBrush.dotWidthVariance = 1;
                        this.canvas.freeDrawingBrush.optimizeOverlapping = true;
                        this.canvas.freeDrawingBrush.randomOpacity = true;
                    case 'MediumSpray':
                        this.canvas.freeDrawingBrush = new fabric.SprayBrush(this.canvas);
                        this.canvas.freeDrawingBrush.density = 10;
                        this.canvas.freeDrawingBrush.dotWidth = 2;
                        this.canvas.freeDrawingBrush.dotWidthVariance = 1;
                        this.canvas.freeDrawingBrush.optimizeOverlapping = true;
                        this.canvas.freeDrawingBrush.randomOpacity = true;
                        break;
                    case 'DenseSpray':
                        this.canvas.freeDrawingBrush = new fabric.SprayBrush(this.canvas);
                        this.canvas.freeDrawingBrush = new fabric.SprayBrush(this.canvas);
                        this.canvas.freeDrawingBrush.density = 100;
                        this.canvas.freeDrawingBrush.dotWidth = 10;
                        this.canvas.freeDrawingBrush.dotWidthVariance = 1;
                        this.canvas.freeDrawingBrush.optimizeOverlapping = true;
                        this.canvas.freeDrawingBrush.randomOpacity = true;
                        break;
                  case 'Pattern':
                    this.canvas.freeDrawingBrush =  new fabric.PatternBrush(this.canvas);
                    break;
                  case 'hline':
                      var hLinePatternBrush = new fabric.PatternBrush(this.canvas);
                      hLinePatternBrush.getPatternSrc = function() {
                          var patternCanvas = fabric.document.createElement('canvas');
                          patternCanvas.width = patternCanvas.height = 10;
                          var ctx = patternCanvas.getContext('2d');
                          ctx.strokeStyle = this.color;
                          ctx.lineWidth = 5;
                          ctx.beginPath();
                          ctx.moveTo(5, 0);
                          ctx.lineTo(5, 10);
                          ctx.closePath();
                          ctx.stroke();
                          return patternCanvas;
                      };
                      this.canvas.freeDrawingBrush = hLinePatternBrush;
                    break;
                  case 'vline':
                    var vLinePatternBrush = new fabric.PatternBrush(this.canvas);
                    vLinePatternBrush.getPatternSrc = function() {
                        var patternCanvas = fabric.document.createElement('canvas');
                        patternCanvas.width = patternCanvas.height = 10;
                        var ctx = patternCanvas.getContext('2d');
                        ctx.strokeStyle = this.color;
                        ctx.lineWidth = 5;
                        ctx.beginPath();
                        ctx.moveTo(0, 5);
                        ctx.lineTo(10, 5);
                        ctx.closePath();
                        ctx.stroke();
                        return patternCanvas;
                    };
                    this.canvas.freeDrawingBrush = vLinePatternBrush;
                    break;
                  case 'Square':
                    var squarePatternBrush = new fabric.PatternBrush(this.canvas);
                    squarePatternBrush.getPatternSrc = function() {
                        var patternCanvas = fabric.document.createElement('canvas');
                        var squareWidth = 10, squareDistance = 5;
                        patternCanvas.width = patternCanvas.height = squareWidth + squareDistance;
                        var ctx = patternCanvas.getContext('2d');
                        ctx.fillStyle = this.color;
                        ctx.fillRect(0, 0, squareWidth, squareWidth);
                        return patternCanvas;
                    };
                    this.canvas.freeDrawingBrush = squarePatternBrush;
                    break;
                  case 'Diamond':
                    var diamondPatternBrush = new fabric.PatternBrush(this.canvas);
                    diamondPatternBrush.getPatternSrc = function() {
                        var squareWidth = 10, squareDistance = 5;
                        var patternCanvas = fabric.document.createElement('canvas');
                        var rect = new fabric.Rect({
                            width: squareWidth,
                            height: squareWidth,
                            angle: 45,
                            fill: this.color
                        });
                        var canvasWidth = rect.getBoundingRectWidth();
                        patternCanvas.width = patternCanvas.height = canvasWidth + squareDistance;
                        rect.set({ left: canvasWidth / 2, top: canvasWidth / 2 });
                        var ctx = patternCanvas.getContext('2d');
                        rect.render(ctx);
                        return patternCanvas;
                    };
                    this.canvas.freeDrawingBrush =diamondPatternBrush;
                    break;
                  case 'Texture':
                    var img = new Image();
                    if (this.brushTexture !== "custom") {
                      img.src = '../assets/texture/' + this.brushTexture + '.png';
                      var texturePatternBrush = new fabric.PatternBrush(this.canvas);
                      texturePatternBrush.source = img;
                      this.canvas.freeDrawingBrush = texturePatternBrush;
                    }
                    break;
                  case 'Pencil':
                  default:
                    this.canvas.freeDrawingBrush = new fabric.PencilBrush(this.canvas);
                }
                this.canvas.freeDrawingBrush.color = this.brushColor;
                this.canvas.freeDrawingBrush.width = this.brushWidth;
                var shadow = this.canvas.freeDrawingBrush.shadow;
                if(!shadow) {
                  shadow = new fabric.Shadow();
                }
                shadow.color = this.brushShadowColor;
                shadow.blur = this.brushShadowBlur;
                shadow.OffsetX = this.brushShadowOffsetX;
                shadow.OffsetY = this.brushShadowOffsetY;
                this.canvas.freeDrawingBrush.shadow  = shadow;
            }
        }
        changeSelected(property, newValue, oldValue) {
          this.log(TRACE,"changeSelected");
          this.log(DEBUG, "property: " , property , " from " + oldValue + " to " + newValue);
          if(this.canvas) {
            var obj = this.canvas.getActiveObject();
            if(obj) {
              obj.set(property, newValue);
              this.canvas.renderAll();
              obj.setCoords();
            } else {
              this.log(DEBUG,"object not selected");
            }
          }
        }
        changeSelectedShadow(property, newValue, oldValue) {
          this.log(TRACE,"changeSelectedShadow");
          this.log(DEBUG,"property: ",property , " from " + oldValue + " to " + newValue);
          if(this.canvas) {
            var obj = this.canvas.getActiveObject();
            if(obj) {
              var shadow = obj.shadow;
              if(property !== null) {
                shadow[property] = newValue;
                obj.shadow = shadow;
                this.shadow = shadow;
                this.shadow = shadow;
                this.textShadow = shadow;
                this.shapeShadow = shadow;
                this.canvas.renderAll();
              }
            } else {
                this.log(DEBUG, "object not selected");
            }
          }
        }
        changeTextDecoration(property, newValue, oldValue) {
          this.log(TRACE,"change Text Decoration");
          this.log(DEBUG,"property: ",property , " from " + oldValue + " to " + newValue);
          if(this.canvas) {
            var obj = this.canvas.getActiveObject();
            if(obj) {
              var value = obj.textDecoration;
              if(!!value.match(property)) {
                value = value.replace(property,"");
              } else {
                value += " " + property;
              }
              value = value.replace(/ +/g," ").trim();
              this.textDecoration = value;
            }
          }
        }
        changeBrushProperty(property, newValue, oldValue) {
          this.log(TRACE,"changeBrushProperty");
          this.log(DEBUG,"property: ", property ," from ", oldValue, " to ",newValue);
          if(this.canvas) {
              this.canvas.freeDrawingBrush[property] = newValue;
          }
        }
        changeBrushShadowProperty(property, newValue, oldValue) {
          this.log(TRACE,"changeBrushShadowProperty");
          this.log(DEBUG,"property: ", property ," from ", oldValue, " to ",newValue);
          if(this.canvas) {
            this.canvas.freeDrawingBrush.shadow[property] = newValue;
          }
        }
        canvasBackgroundColorChange(newValue, oldValue) {
          this.log(TRACE,"canvasBackgroundColorChange");
          this.log(DEBUG,"change from ", oldValue, " to ",newValue);
          if(this.canvas) {
            this.canvas.setBackgroundColor(newValue);
            this.canvas.renderAll(); //.bind(this.canvas);
          }
        }
        brushTextureChange(newValue, oldValue) {
           this.log(TRACE,"brushTextureChange");
           this.log(DEBUG, "change from ", oldValue, " to ", newValue);
            this.hideBrushTextureUpload = (newValue !== "Custom");
            if(newValue === "Custom") {
                this.hideBrushTextureUpload = (this.brushTexture !== "Custom");
            } else {
                if(oldValue) {
                    this.drawingToolChange("brushTexture",oldValue);
                }
            }
        }
      brushWidthChange(newValue, oldValue) {
        this.log(TRACE,"brushWidthChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushWidth = newValue;
        this.changeBrushProperty("width", newValue, oldValue);
      }
      brushOpacityChange(newValue, oldValue) {
        this.log(TRACE,"brushOpacityChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushOpacity = newValue;
        if(this.canvas && this.canvas.freeDrawingBrush.opacity !== 'undefined') {
          this.changeBrushProperty("opacity", newValue, oldValue);
        }
      }
      brushDensityChange(newValue, oldValue) {
        this.log(TRACE,"brushDensityChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushDensity = newValue;
        if(this.canvas && this.canvas.freeDrawingBrush.density !== 'undefined') {
          this.changeBrushProperty("density", newValue, oldValue);
        }
      }
      brushDotWidthChange(newValue, oldValue) {
        this.log(TRACE,"brushDotWidthChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushDotWidth = newValue;
        if(this.canvas && this.canvas.freeDrawingBrush.dotWidth !== 'undefined') {
          this.changeBrushProperty("dotWidth", newValue, oldValue);
        }
      }
      brushDotWidthVarianceChange(newValue, oldValue) {
        this.log(TRACE,"brushDotWidthVarianceChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushDotWidthVariance = newValue;
        if(this.canvas && this.canvas.freeDrawingBrush.dotWidthVariance !== 'undefined') {
          this.changeBrushProperty("dotWidthVariance", newValue, oldValue);
        }
      }

      brushDotWidthDensityChange(newValue, oldValue) {
        this.log(TRACE,"brushDotWidthDensityChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushDotWidthDensity = newValue;
        if(this.canvas && this.canvas.freeDrawingBrush.dotWidthDensity !== 'undefined') {
          this.changeBrushProperty("dotWidthDensity", newValue, oldValue);
        }
      }
      brushColorChange(newValue, oldValue) {
        this.log(TRACE,"brushColorChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushColor = newValue;
        this.changeBrushProperty("color", newValue, oldValue);
      }
      fontFamilyChange(newValue, oldValue) {
        this.log(TRACE,"fontFamilyChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("fontFamily", newValue, oldValue);
      }
      fillChange(newValue, oldValue) {
        this.log(TRACE,"fillChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("fill", newValue, oldValue);
      }
      strokeChange(newValue, oldValue) {
        this.log(TRACE,"strokeChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("stroke", newValue, oldValue);
      }
      textAlignChange(newValue, oldValue) {
        this.log(TRACE,"textAlignChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("textAlign", newValue, oldValue);
      }
      textDecorationChange(newValue, oldValue) {
        this.log(TRACE,"textDecorationChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("textDecoration", newValue, oldValue);
      }
      backgroundColorChange(newValue, oldValue) {
        this.log(TRACE,"backgroundColorChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("backgroundColor", newValue, oldValue);
      }
      textBackgroundColorChange(newValue, oldValue) {
        this.log(TRACE,"textBackgroundColorChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("textBackgroundColor", newValue, oldValue);
      }
      fontSizeChange(newValue, oldValue) {
        this.log(TRACE,"fontSizeChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("fontSize", Number(newValue), oldValue);
      }
      fontWeightChange(newValue, oldValue) {
        this.log(TRACE,"fontWidthChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("fontWeight", newValue, oldValue);
        if(!!newValue.match("bold")) {
          this.$.bold.classList.add('active');
          this.bold = true;
        } else {
          this.$.bold.classList.remove('active');
          this.bold = false;
        }
      }
      fontStyleChange(newValue, oldValue) {
        this.log(TRACE,"fontStyleChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("fontStyle", newValue, oldValue);
        if(!!newValue.match("italic")) {
          this.$.italic.classList.add('active');
          this.italic = true;
        } else {
          this.$.italic.classList.remove('active');
          this.italic = false;
        }
      }
      lineHeightChange(newValue, oldValue) {
        this.log(TRACE,"lineHeightChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("lineHeight", Number(newValue), oldValue);
      }
      charSpacingChange(newValue, oldValue) {
        this.log(TRACE,"charSpacingChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("charSpacing", Number(newValue), oldValue);
      }
      shadowChange(newValue, oldValue) {
        this.log(TRACE,"shadowChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("shadow", newValue, oldValue);
        if(this.canvas) {
          var obj = this.canvas.getActiveObject();
          if(obj) {
            var shadow = obj.shadow;
            this.shadowColor = shadow.color;
            this.shadowBlur = shadow.blur;
            this.shadowOffsetX = shadow.offsetX;
            this.shadowOffsetY = shadow.offsetY;
          }
        }
      }
      shadowColorChange(newValue, oldValue) {
        this.log(TRACE,"shadowColorChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelectedShadow("color", newValue, oldValue);
      }
      shadowBlurChange(newValue, oldValue) {
        this.log(TRACE,"shadowBlurChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelectedShadow("blur", newValue, oldValue);
      }
      shadowOffsetXChange(newValue, oldValue) {
        this.log(TRACE,"shadowOffsetXChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelectedShadow("offsetX", newValue, oldValue);
      }
      shadowOffsetYChange(newValue, oldValue) {
        this.log(TRACE,"shadowOffsetYChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelectedShadow("offsetY", newValue, oldValue);
      }
      angleChange(newValue, oldValue) {
        this.log(TRACE,"angleChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("angle", Number(newValue), oldValue);
      }
      leftChange(newValue, oldValue) {
        this.log(TRACE,"leftChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("left", Number(newValue), oldValue);
      }
      widthChange(newValue, oldValue) {
        this.log(TRACE,"widthChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("width", Number(newValue), oldValue);
      }
      heightChange(newValue, oldValue) {
        this.log(TRACE,"heightChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("height", Number(newValue), oldValue);
      }
      scaleXChange(newValue, oldValue) {
        this.log(TRACE,"scaleXChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("scaleX", Number(newValue), oldValue);
      }
      scaleYChange(newValue, oldValue) {
        this.log(TRACE,"scaleYChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("scaleY", Number(newValue), oldValue);
      }
      flipXChange(newValue, oldValue) {
        this.log(TRACE,"flipXChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("flipX", Boolean(newValue), oldValue);
      }
      flipYChange(newValue, oldValue) {
        this.log(TRACE,"flipYChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("flipY", Boolean(newValue), oldValue);
      }
      origionXChange(newValue, oldValue) {
        this.log(TRACE,"origionXChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("origionX", newValue, oldValue);
      }
      origionYChange(newValue, oldValue) {
        this.log(TRACE,"origionYChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("origionY", newValue, oldValue);
      }
      transformMatrixChange(newValue, oldValue) {
        this.log(TRACE,"transformMatrixChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("transformMatrix", newValue, oldValue);
      }
      strokeWidthChange(newValue, oldValue) {
        this.log(TRACE,"strokeWidthChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("strokeWidth", Number(newValue), oldValue);
      }
      strokeDashArrayChange(newValue, oldValue) {
        this.log(TRACE,"strokeDashArrayChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        var newArray = [0];
        if(newValue) {
          if(Array.isArray(newValue)) {
            newArray = newValue;
          } else if(!!newValue.match(/\[.*\]/)) {
            newArray = eval(newValue);
          } else if(!!newValue.match(/\d/)) {
            newArray = newValue.split(/[ ,]+/);
          }
        }
        this.changeSelected("strokeDashArray", newArray, oldValue);
      }
      strokeLineStyleChange(newValue, oldValue) {
        this.log(TRACE,"strokeLineStyleChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        var value = [0];
        switch(newValue) {
          case 'Solid':
            value = [0];
            break;
          case "Dotted":
            value = [2,2];
            break;
          case "Dashed":
            value = [6,6];
            break;
          case "DotDash":
            value = [2,5,5,5];
            break;
          case "Custom":
          default:
            value = this.strokeDashArray;
        }
        if(newValue === "Custom") {
          this.$.strokeDashArray.classList.remove("hide");
        } else {
          this.$.strokeDashArray.classList.add("hide")
        }
        this.strokeLineStyle = newValue;
        this.strokeDashArray = value;
        //this.strokeDashArrayChange(value, oldValue);
      }
      strokeLineCapChange(newValue, oldValue) {
        this.log(TRACE,"strokeLineCapChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("strokeLineCap", newValue, oldValue);
      }
      strokeLineJointChange(newValue, oldValue) {
        this.log(TRACE,"strokeLineJointChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("strokeLineJoint", newValue, oldValue);
      }
      strokeMiterLimitChange(newValue, oldValue) {
        this.log(TRACE,"strokeMiterLimitChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("strokeMiterLimit", Number(newValue), oldValue);
      }
      opacityChange(newValue, oldValue) {
        this.log(TRACE,"opacityChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("opacity", Number(newValue), oldValue);
      }
      fillRuleChange(newValue, oldValue) {
        this.log(TRACE,"fillRuleChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("fillRule", newValue, oldValue);
      }
      globalCompositeOperationChange(newValue, oldValue) {
        this.log(TRACE,"globalCompositeOperationChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("globalCompositOperation", newValue, oldValue);
      }
      clipToChange(newValue, oldValue) {
        this.log(TRACE,"clipToChange");
        this.log(DEBUG,"change from ",oldValue," to ",newValue);
        this.changeSelected("clipTo", newValue, oldValue);
      }
      visibleChange(newValue, oldValue) {
        this.log(TRACE,"visibleChange");
        this.log(DEBUG,"change from ", oldValue, " to ", newValue);
        this.changeSelected("visible", Boolean(newValue), oldValue);
      }
      skewXChange(newValue, oldValue) {
        this.log(TRACE,"skewXChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("skewX", Number(newValue), oldValue);
      }
      skewYChange(newValue, oldValue) {
        this.log(TRACE,"skewYChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("skewY", Number(newValue), oldValue);
      }
      textChange(newValue, oldValue) {
        this.log(TRACE,"textChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("text", newValue, oldValue);
      }
      alignXChange(newValue, oldValue) {
        this.log(TRACE,"alignXChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("alignX", newValue, oldValue);
      }
      alignYChange(newValue, oldValue) {
        this.log(TRACE,"alignYChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("alignY", newValue, oldValue);
      }
      meetOrSliceChange(newValue, oldValue) {
        this.log(TRACE,"meetOrSliceChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("meetOrSlice", newValue, oldValue);
      }

      brushShadowColorChange(newValue, oldValue) {
        this.log(TRACE,"brushShadowColorChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushShadowColor = newValue;
        this.changeBrushShadowProperty("color", newValue, oldValue);
      }
      brushShadowBlurChange(newValue, oldValue) {
        this.log(TRACE,"brushShadowBlurChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushShadowBlur = newValue;
        this.changeBrushShadowProperty("blur", Number(newValue), oldValue);
      }
      brushShadowOffsetXChange(newValue, oldValue) {
        this.log(TRACE,"brushShadowOffsetXChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushShadowOffsetX = newValue;
        this.changeBrushShadowProperty("offsetX", Number(newValue), oldValue);
      }
      brushShadowOffsetYChange(newValue, oldValue) {
        this.log(TRACE,"brushShadowOffsetYChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.brushShadowOffestY = newValue;
        this.changeBrushShadowProperty("offsetY", Number(newValue), oldValue);
      }
      boldChange(newValue, oldValue) {
        this.log(TRACE,"boldChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        if(newValue) {
          this.$.bold.classList.add('active');
          this.fontWeight = "bold";
        } else {
          this.$.bold.classList.remove('active');
          this.fontWeight = "normal";
        }
      }
      italicChange(newValue, oldValue) {
        this.log(TRACE,"italicChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        if(newValue) {
          this.$.italic.classList.add('active');
          this.fontStyle = "italic";
        } else {
          this.$.italic.classList.remove('active');
          this.fontStyle = "normal";
        }
      }
      underlineChange(newValue, oldValue) {
        this.log(TRACE,"underlineChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeTextDecoration("underline", newValue, oldValue);
      }
      linethroughChange(newValue, oldValue) {
        this.log(TRACE,"linetrhoughChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeTextDecoration("line-through", newValue, oldValue);
      }
      overlineChange(newValue, oldValue) {
        this.log(TRACE,"overlineChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeTextDecoration("overline", newValue, oldValue);
      }
      topChange(newValue, oldValue) {
        this.log(TRACE,"topChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("top", Number(newValue), oldValue);
      }
      rxChange(newValue, oldValue) {
        this.log(TRACE,"rxChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("rx", newValue, oldValue);
      }
      ryChange(newValue, oldValue) {
        this.log(TRACE,"ryChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("ry", newValue, oldValue);
      }
      xChange(newValue, oldValue) {
        this.log(TRACE,"xChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("x", newValue, oldValue);
      }
      yChange(newValue, oldValue) {
        this.log(TRACE,"yChange");
        this.log(DEBUG, "change from ", oldValue, " to ", newValue);
        this.changeSelected("y", newValue, oldValue);
      }
      regularPolygonPoints(sideCount,radius) {
        this.log(TRACE,"regularPolygonPoints");
        this.log(DEBUG,"sideCount: ", sideCount, "radius: ", radius);
        var sweep=Math.PI*2/sideCount;
        var cx=radius;
        var cy=radius;
        var points=[];
        for(var i=0;i<sideCount;i++){
          var x=cx+radius*Math.cos(i*sweep);
          var y=cy+radius*Math.sin(i*sweep);
          points.push({x:x,y:y});
        }
        return(points);
      }
      starPolygonPoints(spikeCount, outerRadius, innerRadius) {
        this.log(TRACE,"starPolygonPoints");
        this.log(DEBUG,"spikeCount: ", spikeCount, " outerRadius: ", outerRadius, "innerRadius: ", innerRadius);
        var rot = Math.PI / 2 * 3;
        var cx = outerRadius;
        var cy = outerRadius;
        var sweep = Math.PI / spikeCount;
        var points = [];
        var angle = 0;

        for (var i = 0; i < spikeCount; i++) {
          var x = cx + Math.cos(angle) * outerRadius;
          var y = cy + Math.sin(angle) * outerRadius;
          points.push({x: x, y: y});
          angle += sweep;

          x = cx + Math.cos(angle) * innerRadius;
          y = cy + Math.sin(angle) * innerRadius;
          points.push({x: x, y: y});
          angle += sweep
        }
        return (points);
      }
      createArrowHead(points) {
        this.log(TRACE,"createArrowHead");
        this.log(DEBUG,"points: ", points);
        var headLength = 15,

        x1 = points[0],
        y1 = points[1],
        x2 = points[2],
        y2 = points[3],

        dx = x2 - x1,
        dy = y2 - y1,

        angle = Math.atan2(dy, dx);

        angle *= 180 / Math.PI;
        angle += 90;

        var triangle = new fabric.Triangle({
          angle: angle,
          fill: '#207cca',
          top: y2,
          left: x2,
          height: headLength,
          width: headLength,
          originX: 'center',
          originY: 'top',
          selectable: false
        });
        return triangle;
      }

      loadDropedFile(e) {  // drag drop to canvas
        this.log(TRACE,"loadDropedFile");
        e.preventDefault();
        this.addFileToCanvas(e.dataTransfer.files[0], ELEMENT);
      }

      loadDropedBackgroundFile(e) {  // drag drop to canvas
        this.log(TRACE,"loadDropedBackgroundFile");
        e.preventDefault();
        this.addFileToCanvas(e.dataTransfer.files[0], BACKGROUND);
      }

      loadDropedCanvasFile(e) {  // drag drop to canvas
        this.log(TRACE,"loadDropedCanvasFile");
        e.preventDefault();
        this.canvas.clear();
        this.addFileToCanvas(e.dataTransfer.files[0], CANVAS);
      }

      loadSelectedFile(e) {  // upload to canvas
        this.log(TRACE,"loadSelectedFile");
        e.preventDefault();
        this.addFileToCanvas(e.target.files[0], ELEMENT);
      }

      loadCanvasFile(e) {  // upload to canvas
        this.log(TRACE,"loadCanvasFile");
        e.preventDefault();
        this.canvas.clear();
        this.addFileToCanvas(e.target.files[0], CANVAS);
      }

      loadBackgroundFile(e) {  // upload to canvas
        this.log(TRACE,"loadBackgroundFile");
        e.preventDefault();
        this.addFileToCanvas(e.target.files[0], BACKGROUND);
      }

      addFileToCanvas(file, option) {
        this.log(TRACE,"addFileToCanvas");
        this.log(DEBUG, "file: ", file.name, " type: ", file.type, " option: ", option);
        var t = this;
        var canvas = this.canvas;
        var fileReader = new FileReader();
        if(!!file.type.match(/image.*/)) {
          fileReader.onload = function (e) {
            switch(option) {
              case BACKGROUND:
                fabric.Image.fromURL(e.target.result, function(img) {
                  img.width = canvas.width;
                  img.height = canvas.height;
                  canvas.setBackgroundImage(img);
                  canvas.renderAll();
                });
                break;
              case CANVAS:
                fabric.Image.fromURL(e.target.result, function(img) {
                  img.width = canvas.width;
                  img.height = canvas.height;
                  canvas.add(img);
                  img.setCoords();
                  canvas.renderAll();
                });
                break;
              case OBJECT:
              default:
                fabric.Image.fromURL(e.target.result, function(img) {
                  if (img.width > canvas.width) {  // center the object
                    img.height *= canvas.width / img.width;
                    img.width = canvas.width;
                  }
                  if(img.height > canvas.height) {  // center the object
                    img.width *= canvas.height / img.height;
                    img.height = canvas.height;
                  }
                  canvas.add(img);
                  canvas.centerObject(img);
                  img.setCoords();
                  canvas.renderAll();
                });
                break;
            }
          }
          fileReader.readAsDataURL(file);
        } else {
          console.log("Adding NON Image file: ", file.name, file.extention, file);

          switch(file.name.match(/(.*)\??/i).shift().replace(/\?.*/, '').split('.').pop()) {
            case 'json':
              console.log("Adding JSON file");
              switch(option) {
                case BACKGROUND:
                  fileReader.onload = function (e) {
                    fabric.Image.fromURL(e.target.result, function(img) {
                      img.width = canvas.width;
                      img.height = canvas.height;
                      canvas.setBackgroundImage(img);
                      canvas.renderAll();
                    });
                  }
                  break;
                case CANVAS:
                case ELEMENT:
                  fileReader.onload = function (e) {
                    canvas.loadFromJSON(JSON.parse(e.target.result), canvas.renderAll.bind(canvas));
                  };
                  break;
                }
              break;
            case "svg":
              switch(option) {
                case BACKGROUND:
                  fileReader.onload = function (e) {
                    var url = e.target.result;
                    fabric.Image.fromURL(url, function(img) {
                      img.width = canvas.width;
                      img.height = canvas.height;
                      canvas.setBackgroundImage(img);
                      canvas.renderAll();
                    });
                  }
                  break;
                case ELEMENT:  // group svg an load
                  fileReader.onload = function (e) {
                    fabric.loadSVGFromURL(file, function(objects, options) {
                      var obj = fabric.util.groupSVGElements(objects, options);
                      if (obj.width > canvas.width) {  // center the object
                        obj.height *= canvas.width / obj.width;
                        obj.width = canvas.width;
                      }
                      if(obj.height > canvas.height) {  // center the object
                        obj.width *= canvas.height / obj.height;
                        obj.height = canvas.height;
                      }
                      canvas.add(obj);
                      canvas.centerObject(obj);
                      obj.setCoords();
                      canvas.renderAll();
                    });
                  }
                  break;
                case CANVAS:  // load raw - do not group
                  fileReader.onload = function (e) {
                    fabric.loadSVGFromURL(file, function (objects) {
                      canvas.add.apply(canvas, objects);
                      canvas.renderAll();
                    });
                  }
                  break;
                default:
                  alert('Selected file "' + file.name + '" is not supported');
                  return;
              }
            }
          fileReader.readAsText(file);
        }
      }

      loadDropedBrushTextureFile(e) {  // upload to canvas brush
        this.log(TRACE,"loadDropedBrushTextureFile");
        e.preventDefault();
        this.setBrushTextureFile(e.dataTransfer.files[0]);
      }

      loadBrushTextureFile(e) {  // upload to canvas brush
        this.log(TRACE,"loadBrushTextureFile");
        e.preventDefault();
        this.setBrushTextureFile(e.target.files[0]);
      }

      setBrushTextureFile(file) {
        this.log(TRACE,"setBrushTextureFile");
        this.log(DEBUG, "file: ", file.name);
        var canvas = this.canvas;
        if(!file.type.match(/image.*/)) { // Prevent any non-image file type from being read.
            alert(file.name + " is not an image");
            return;
        }
        var img = document.createElement("img");
        var fileReader = new FileReader();
        fileReader.onload = (function (image) {
          return function (e) {
            image.src = e.target.result;
          };
        }(img));
        fileReader.readAsDataURL(file);

        img.width = 100;
        img.height = 100;

        var texturePatternBrush = new fabric.PatternBrush(canvas);
        texturePatternBrush.source = img;
        canvas.freeDrawingBrush = texturePatternBrush;
        canvas.freeDrawingBrush.color = this.brushColor;
        canvas.freeDrawingBrush.width = this.brushWidth;
        var shadow = canvas.freeDrawingBrush.shadow;
        if(!shadow) {
          shadow = new fabriclshadow();
        }
        shadow.color = this.brushShadowColor;
        shadow.blur = this.brushShadowBlur;
        shadow.offsetX = this.brushShadowOffsetX;
        shadow.offsetY = this.brushShadowOffsetY;
        canvas.freeDrawingBrush.shadow = shadow;
      }

      toggleCssClass(element, cls) {
         this.log(TRACE,"toggleCssClass");
         this.log(DEBUG,"element id: " + element.id + " cls: " + cls);
         if(element.classList.contains(cls)) {
             element.classList.remove(cls);
         } else {
             element.classList.add(cls);
         }
       }

       toggleActive(id, value) {
         this.log(TRACE,"togleActive");
         this.log(DEBUG,"id: ", id, "value: ", value);
         //this.toggleCssClass(this.$[],"active");
         var element = this.$[id];
         var newValue = !value;
         if(newValue === true) {
           element.classList.add("active");
         } else {
           element.classList.remove("active");
         }
         return newValue;
       }

       setActive(id, value) {
         this.log(TRACE,"setActive");
         this.log(DEBUG,"id: ",id, "value: ", value);
         var element = this.$[id];
         if(value === true) {
           element.classList.add("active");
         } else {
           element.classList.remove("active");
         }
       }

      showMenu(menu) {
        this.log(TRACE,"showMenu");
        this.log(DEBUG,"menu: ", menu);
        this.selectedMenu = menu;
        this.hideText = (menu !== "text");
        this.hideShape = (menu !== "shape");
        this.hideFile = (menu !== "file");
        if(menu === "text") {
          this.hideText = false;
          this.$.textButton.classList.add("active");
        } else {
          this.hideText = true;
          this.$.textButton.classList.remove("active");
        }
        if(menu === "shape") {
          this.hideShape = false;
          this.$.shapeButton.classList.add("active");
        } else {
          this.hideShape = true;
          this.$.shapeButton.classList.remove("active");
        }
        if(menu === "file") {
          this.hideFile = false;
          this.$.fileButton.classList.add("active");
        } else {
          this.hideFile = true;
          this.$.fileButton.classList.remove("active");
        }
        if(menu === "draw") {
          this.hideDraw = false;
          this.$.drawButton.classList.add("active");
        } else {
          this.hideDraw = true;
          this.canvas.isDrawingMode = false;
          this.$.drawButton.classList.remove("active");
        }
        if(menu === "control") {
          this.hideControl = false;
          this.$.controlButton.classList.add("active");
        } else {
          this.hideControl = true;
          this.$.controlButton.classList.remove("active");
        }
      }
      clearView() {  // hide the Edit Elements
        this.log(TRACE,"clearView");
        var elements = this.$;
        for(var key in elements) {
          var element = elements[key];
          var elementId = element.id;
          if(!!elementId.match(/.*Edit$/)) {
            element.classList.add('hide');
            console.log("hide",element.id);
          }
        }
      }
      loadTextView() {
        this.log(TRACE,"loadTextView");
        this.clearView();
        this.showMenu("text");
        var obj = this.canvas.getActiveObject();
        if(obj && !!obj.type.match(/text/i)) {
          this.bold = obj.fontWeight == 'bold' ? 'bold' : 'normal';
          this.italic = obj.fontStyle == 'italic' ? 'italic' : 'normal';
          var textDecoration = obj.textDecoration;
          this.underline = !!textDecoration.match(/underline/);
          this.linethrough = !!textDecoration.match(/line-through/);
          this.overline = !!textDecoration.match(/overline/);
          this.fontFamily = obj.fontFamily;
          this.textAlign = obj.textAlign;
          this.fill = obj.fill;
          this.stroke = obj.stroke;
          this.backgroundColor = obj.backgroundColor;
          this.textBackgroundColor = obj.textBackgroundColor;
          this.strokeWIdth = obj.strokeWidth;
          this.fontSize = obj.fontSize;
          this.lineHeight = obj.lineHeight;
          this.charSpacing = obj.charSpacing;
          var shadow = obj.shadow;
          if(shadow) {
            this.shadowColor = shadow.color;
            this.shadowBlur = shadow.blur;
            this.offsetX = shadow.offsetX;
            this.textShadopwOffsetY = shadow.offsetY;
          }
          var text = obj.text;
          this.text = text;
          this.$.text.value = text;
        }
        var fields = [
          "fontWeight", //  normal, bold
          "fontStyle", //  normal, italic, oblique, ''
          "textDecoration", //  underline, linethrough, overline
          "fontFamily",
          "textAlign",
          "fill",
          "stroke",
          "backgroundColor",
          "textBackgroundColor",
          "strokeWidth",
          "fontSize",
          "lineHeight",
          "charSpacing",
          "shadow", //  shadowColor, shadowBlur, shadowOffsetX, shadowOffsetY
          "shadowColor",
          "shadowBlur",
          "shadowOffsetX",
          "shadowOffsetY",
          "text",
          "addText"
        ];

        this.hideControl = false;
        //this.$.controlButton.classList.add("active");
        for(var key in fields) {
          var id = fields[key] + "Edit";
          var element = this.$[id];
          if(element) {
            element.classList.remove('hide');
          }
        }
      }
      loadShapeView() {
        this.log(TRACE,"loadShapeView");
        this.clearView();
        this.showMenu("shape");
        var obj = this.canvas.getActiveObject();
        if(obj) {
          this.fill = obj.fill;
          this.stroke = obj.stroke;
          this.strokeWidth = obj.strokeWidth;
          this.strokeDashArray = obj.strokeDashArray;
          this.angle = obj.angle;
          var shadow = obj.shadow;
          if(shadow) {
            this.shadowColor = shadow.color;
            this.shadowBlur = shadow.blur;
            this.shadowOffsetX = shadow.offsetX;
            this.shapeShadowOfsetY = shadow.offsetY;
          }
        }
        var fields = [
          "fill",
          "stroke",
          "strokeWidth",
          "strokeDashArray",
          "angle",
          "shadow", //  shadowColor, shadowBlur, shadowOffsetX, shadowOffsetY
          "shadowColor",
          "shadowBlur",
          "shadowOffsetX",
          "shadowOffsetY",
        ];

        this.hideControl = false;
        //this.$.controlButton.classList.add("active");
        for(var key in fields) {
          var id = fields[key] + "Edit";
          var element = this.$[id];
          if(element) {
            element.classList.remove('hide');
            console.log("show",element.id);
          }
        }
      }
      loadFileView() {
        this.log(TRACE,"loadFileView");
        this.clearView();
        this.showMenu("file");
      }
      loadDrawView() {
        this.log(TRACE,"loadDrawView");
        this.clearView();
        this.showMenu("draw");
        var obj = this.canvas.getActiveObject();
        if(obj) {
          var freeDrawingBrush = this.canvas.freedrawingBrush;
          if(freeDrawingBrush) {
            this.brushColor = freeDrawingBrush.color;
            this.brushWidth = freeDrawingBrush.width;
            this.brushShadowColor = freeDrawingBrush.shadow.color;
            this.brushShadowBlur = freeDrawingBrush.shadow.blur;
            this.brushShadowOffsetX = freeDrawingBrush.shadow.offsetX ;
            this.brushShadowOffsetY = freeDrawingBrush.shadow.offsetY ;
          }
        }
      }

      loadControlView() {
        this.log(TRACE,"loadControlView");
        this.clearView();
        this.showMenu("control");
        var obj = this.canvas.getActiveObject();
        for(var key in obj) {
          var type = typeof this[key];
          var objectType = typeof(obj.get(key));
          this[key] = obj.get(key);
          if (objectType === 'function'  || type === 'undefined') {
            continue;
          }
          var objType = obj.get('type');
          var value = obj.get(key);
          this[key] = value;

          if(!!key.match(/^lock/)) {
            var element = this.$[key];
            if(value === true) {
                element.classList.add('active');
              } else {
                element.classList.remove('active');
              }
          }

          this.$.groupEdit.classList.remove('hide');
          this.$.positionEdit.classList.remove('hide');
          this.$.lockEdit.classList.remove('hide');
          var elementId = key + "Edit";
          var element = this.$[elementId];
          if(element != null) {
              element.classList.remove('hide');
          }
        }
        if(obj) {
          var textDecoration = obj.textDecoration;
          if(!textDecoration) {
            textDecoration = "";
          }
          this.underline = !!textDecoration.match(/underline/);
          this.linethrough = !!textDecoration.match(/line-through/);
          this.overline = !!textDecoration.match(/overline/);
          this.setActive('underline',this.underline);
          this.setActive('linethrough',this.linethrough);
          this.setActive('overline',this.overline);
          var strokeDashArray = obj.strokeDashArray;
          var strokeLineStyle = "solid";
          switch (strokeDashArray.toString) {
            case "0":
            case "0,0":
              strokeLinestyle = "Solid";
              break;
            case "2,2":
              var strokeLinestyle = "Dotted";
            break;
              case "6,6":
              var strokeLinestyle = "Dashed";
            break;
              case "1,5,5,5":
              var strokeLinestyle = "DotDash";
              break;
            default:
              var strokeLinestyle = "Custom";
          }
          this.strokeLineStyle = strokeLineStyle;
          if(strokeLineStyle == "Custom") {
            this.$.strokeDashArray.classList.remove("hide");
          } else {
            this.$.strokeDashArray.classList.add("hide");
          }
        }
      }

      setProperty(property, value) {
        this.log(TRACE,"setProperty");
        this.log(DEBUG,"set property:", property, "value:", value);
        this.canvas.set(property, value);
      }

      selectedContains(property) {
        this.log(Trace,"selectedContains");
        this.log(DEBUG, "property: ", property);
        return true;
        if(this.canvas) {
          var selected = this.canvas.getActiveObject();
          if (selected) {
            var stateProperties = selected.stateProperties;
            if(stateProperties.indexOf(property)) {
              this.log(DEBUG,"selectedContains:",property , true);
              return true;
            } else {
              this.log(DEBUG,"selectedContains: no active object");
            }
          }
        } else {
          this.log(DEBUG,"selectedContains: canvas not set");
        }
        this.log(DEBUG,"selectedContains:",property , false);
        return false;
      }

      downloadCanvas(e) {
        this.log(TRACE, "downCanvas");
        var filePrefix = this.downloadFileNamePrefix;
        switch(this.downloadFileExtension) {
          case "png":
          this.downloadCanvasAsPNG(filePrefix);
          break;
          case "jpeg":
          case "jpg":
            this.downloadCanvasAsJPEG(filePrefix);
            break;
          case "svg":
            this.downloadCanvasAsSVG(filePrefix);
            break;
          case "json":
          default:
            this.downloadCanvasAsJSON(filePrefix)
        }
      }

      downloadCanvasAsPNG(filePrefix) {
        this.log(TRACE, "downloadAsPNGImage");
        this.log(DEBUG, "filePrefix: ", filePrefix);
        var link = document.createElement("a");
        link.href = this.canvas.toDataURL();
        this.log(DEBUG, "saveImage", link.href);
        link.download = filePrefix + '.png';
        link.click();
      }

      downloadCanvasAsJPEG(filePrefix) {
        this.log(TRACE, "downloadAsJPEGImage");
        this.log(DEBUG, "filePrefix: ", filePrefix);
        var link = document.createElement("a");
        link.href = this.canvas.toDataURL("image/jpeg", 0.8);
        this.log(DEBUG, "saveImage", link.href);
        link.download = filePrefix + '.jpeg';
        link.click();
      }

      downloadCanvasAsJSON(filePrefix) {
        this.log(TRACE, "downloadAsJSON");
        this.log(DEBUG, "filePrefix: ", filePrefix);
        var link = document.createElement('a');
        link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(this.canvas.toJSON()));
        link.download = filePrefix + ".json";
        if (document.createEvent) {
          var event = document.createEvent('MouseEvents');
          event.initEvent('click', true, true);
          link.dispatchEvent(event);
        } else {
          link.click();
        }
      }

      downloadCanvasAsSVG(filePrefix) {
        this.log(TRACE, "downloadAsSVG");
        this.log(DEBUG, "filePrefix: ", filePrefix);
        var link = document.createElement('a');
        link.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(this.canvas.toSVG());
        link.download = filePrefix + ".svg";
        if (document.createEvent) {
          var event = document.createEvent('MouseEvents');
          event.initEvent('click', true, true);
          link.dispatchEvent(event);
        } else {
          link.click();
        }
      }

      log() {
        // this.log(TRACE,"log");  wold cause recursion
        if(arguments[0] <= this.logLevel) {
          var level = '';
          var out = '';
          switch(arguments[0]) {
            case ALL:
              break;
            case TRACE:
              level = "Trace";
              break;
            case DEBUG:
              level = "Debug";
              break;
            case ERROR:
              level = "Error";
              break;
            case WARNING:
              level = "Warning";
            break;
            case STATUS:
              level = "Status";
              break;
            case INFO:
              level = "Info";
            default:
              level = "Unknown"
          }
          out += level + ": ";
          for(var i=1,l=arguments.length; i<l; i++) {
            if(i > 2) {
              out += ' ';
            }
            out += arguments[i];
          }
          arguments[0] = level;
          console.log(arguments);
        }
      }

    }

    // Register custom element definition using standard platform API
    customElements.define(Polymer2FabricEdit.is, Polymer2FabricEdit);

  </script>
</dom-module>
